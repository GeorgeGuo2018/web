<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/web/zh/docs/faq/permission/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/web/favicons/favicon.ico><link rel=apple-touch-icon href=/web/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/web/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/web/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/web/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/web/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/web/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/web/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/web/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/web/favicons/android-192x192.png sizes=192x192><title>授权类 | Tkestack</title><meta name=description content="生产级别多集群管理系统"><meta property="og:title" content="授权类"><meta property="og:description" content="授权类
"><meta property="og:type" content="website"><meta property="og:url" content="/web/zh/docs/faq/permission/"><meta property="og:site_name" content="Tkestack"><meta itemprop=name content="授权类"><meta itemprop=description content="授权类
"><meta name=twitter:card content="summary"><meta name=twitter:title content="授权类"><meta name=twitter:description content="授权类
"><link rel=preload href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css as=style><link href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/web/zh/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Tkestack</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/docs/><span>Docs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/blog/><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文 Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/web/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/web/zh/docs/faq/permission/>返回本页常规视图</a>.</p></div><h1 class=title>授权类</h1><div class=lead>授权类</div><ul><li>1: <a href=#pg-56f2c8b60c47f16b171887c38367950f>如何接入LDAP&OIDC</a></li><li>2: <a href=#pg-05076fe8aeb095463eaccb5d860062f0>业务管理、平台管理的区别</a></li><li>3: <a href=#pg-099d9f2df6422d0a0b9d50e89523f96b>如何设置自定义策略</a></li><li>4: <a href=#pg-3ad51762ec0ad9d317d937de9913ff4f>Docker login 权限错误</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-56f2c8b60c47f16b171887c38367950f>1 - 如何接入LDAP&OIDC</h1><div class=lead>如何接入LDAP&OIDC</div><p>接入LDAP、OIDC有两种方式；</p><ol><li>在集群安装时，配置OIDC认证信息，关于OIDC配置信息，请参考<a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#configuring-the-api-server>Configuring the API Server</a>。</li></ol><p><img src=../../../../images/installer-oidc.png alt=installer-oidc></p><ol><li><p>集群安装完成后，可以通过调用API的形式切换认证模式为OIDC或LDAP</p><p>a. 修改auth配置文件，configmap: tke-auth-api，指定默认idp类型为ldap：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#4e9a06>&#34;auth&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#4e9a06>&#34;init_tenant_type&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ldap&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>// 指定ldap类型的idp
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#4e9a06>&#34;init_tenant_id&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ldap-test&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>// tenant id
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#4e9a06>&#34;init_idp_administrators&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;jane&#34;</span><span style=color:#000;font-weight:700>],</span> <span style=color:#8f5902;font-style:italic>//idp的管理员列表，需要存在客户ldap系统中，具有平台的超级管理员权限
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#4e9a06>&#34;ldap_config_file&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#4e9a06>&#34;_debug/auth-ldap.json&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>b. 准备ldap配置文件，配置说明参见：<a href=https://github.com/dexidp/dex/blob/master/Documentation/connectors/ldap.md>dex-ldap</a></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//ldap地址，host:port
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#4e9a06>&#34;host&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;localhost:389&#34;</span><span style=color:#000;font-weight:700>,</span> 
    <span style=color:#4e9a06>&#34;insecureNoSSL&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>// 是否开始SSL，如果host没有指定端口，ture，端口为389和false， 端口为636
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#4e9a06>&#34;bindDN&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cn=admin,dc=example,dc=org&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>//服务账户的DN和密码，用来查询ldap用户组和用户
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#4e9a06>&#34;bindPW&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;admin&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>//密码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#4e9a06>&#34;usernamePrompt&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;User Name&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#4e9a06>&#34;userSearch&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;baseDN&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ou=People,dc=example,dc=org&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>//用户baseDN
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#4e9a06>&#34;filter&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;(objectClass=person)&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>//查询过滤条件
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#4e9a06>&#34;username&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cn&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>// username的属性key，cn=jane,ou=People,dc=example,dc=org
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#4e9a06>&#34;idAttr&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;DN&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>// user id的属性key
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#4e9a06>&#34;emailAttr&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;mail&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>// 邮件属性key
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#4e9a06>&#34;nameAttr&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cn&#34;</span> <span style=color:#8f5902;font-style:italic>//displayname 的属性key
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#4e9a06>&#34;groupSearch&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;baseDN&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ou=Groups,dc=example,dc=org&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#8f5902;font-style:italic>//用户组baseDN
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#4e9a06>&#34;filter&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;(objectClass=groupOfNames)&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>//查询过滤条件
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#4e9a06>&#34;userAttr&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;DN&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>//用户组成员id属性key
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#4e9a06>&#34;groupAttr&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;member&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>//用户组成员key
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#4e9a06>&#34;nameAttr&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cn&#34;</span> <span style=color:#8f5902;font-style:italic>//用户组名称key
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>c. 调用API，新增ldap idp，</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>curl -XPOST https://{auth_address}/apis/auth.tkestack.io/v1/identityproviders   -H &#39;Authorization: Bearer {admin_token}&#39;    -H &#39;Content-Type: application/json&#39;
</code></pre></div><p>​ Body:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#000;font-weight:700>{</span>
    <span style=color:#4e9a06>&#34;metadata&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ldap-test&#34;</span> <span style=color:#8f5902;font-style:italic>//tennatID
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#4e9a06>&#34;spec&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ldap-test&#34;</span><span style=color:#000;font-weight:700>,</span> 
        <span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ldap&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;administrators&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>  <span style=color:#8f5902;font-style:italic>//超级管理员
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#4e9a06>&#34;jane&#34;</span>
        <span style=color:#000;font-weight:700>],</span>
        <span style=color:#4e9a06>&#34;config&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;  {\&#34;host\&#34;:\&#34;localhost:389\&#34;,\&#34;insecureNoSSL\&#34;:true,\&#34;bindDN\&#34;:\&#34;cn=admin,dc=example,dc=org\&#34;,\&#34;bindPW\&#34;:\&#34;admin\&#34;,\&#34;usernamePrompt\&#34;:\&#34;Email Address\&#34;,\&#34;userSearch\&#34;:{\&#34;baseDN\&#34;:\&#34;ou=People,dc=example,dc=org\&#34;,\&#34;filter\&#34;:\&#34;(objectClass=person)\&#34;,\&#34;username\&#34;:\&#34;cn\&#34;,\&#34;idAttr\&#34;:\&#34;DN\&#34;,\&#34;emailAttr\&#34;:\&#34;mail\&#34;,\&#34;nameAttr\&#34;:\&#34;cn\&#34;},\&#34;groupSearch\&#34;:{\&#34;baseDN\&#34;:\&#34;ou=Groups,dc=example,dc=org\&#34;,\&#34;filter\&#34;:\&#34;(objectClass=groupOfNames)\&#34;,\&#34;userAttr\&#34;:\&#34;DN\&#34;,\&#34;groupAttr\&#34;:\&#34;member\&#34;,\&#34;nameAttr\&#34;:\&#34;cn\&#34;}}&#34;</span> <span style=color:#8f5902;font-style:italic>//ldap配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div></li></ol><p>d. 删除IDP</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>   curl -XDELETE https://{auth_address}/apis/auth.tkestack.io/v1/identityproviders/ldap-test -H &#39;Authorization: Bearer {admin_token}&#39;
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-05076fe8aeb095463eaccb5d860062f0>2 - 业务管理、平台管理的区别</h1><div class=lead>业务管理、平台管理的区别</div><p>TKEStack的权限体系分为业务使用者和平台管理员两种角色，平台管理员可以管理平台所有功能，业务使用者可以访问自己有权限的业务或者namespace下的资源。同时平台管理员可以通过自定义策略，定义不同的策略类型。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-099d9f2df6422d0a0b9d50e89523f96b>3 - 如何设置自定义策略</h1><div class=lead>如何设置自定义策略</div><p>TKEStack 策略（policy）用来描述授权的具体信息。核心元素包括操作（action）、资源（resource）以及效力（effect）。</p><h2 id=操作action>操作（action）</h2><p>描述允许或拒绝的操作。操作可以是 API（以 name 前缀描述）或者功能集（一组特定的 API，以 permid 前缀描述）。该元素是必填项。</p><h2 id=资源resource>资源（resource）</h2><p>描述授权的具体数据。资源是用六段式描述。每款产品的资源定义详情会有所区别。有关如何指定资源的信息，请参阅您编写的资源声明所对应的产品文档。该元素是必填项。</p><h2 id=效力effect>效力（effect）</h2><p>描述声明产生的结果是“允许”还是“显式拒绝”。包括 allow（允许）和 deny （显式拒绝）两种情况。该元素是必填项。</p><h2 id=策略样例>策略样例</h2><p>该样例描述为：允许关联到此策略的用户，对cls-123集群下的工作负载deploy-123中的所有资源，有查看权限。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#000;font-weight:700>{</span>
  <span style=color:#4e9a06>&#34;actions&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#4e9a06>&#34;get*&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#4e9a06>&#34;list*&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#4e9a06>&#34;watch*&#34;</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#4e9a06>&#34;resources&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#4e9a06>&#34;cluster:cls-123/deployment:deploy-123/*&#34;</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#4e9a06>&#34;effect&#34;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;allow&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-3ad51762ec0ad9d317d937de9913ff4f>4 - Docker login 权限错误</h1><div class=lead>Docker login 权限错误</div><h2 id=docker-login-权限错误>Docker login 权限错误</h2><p>在Tkestack选用用了自建证书，需要用户在客户端手动导入，docker login 权限报错：certificate signed by unknown authority。</p><h2 id=方法一>方法一</h2><p>在 Global 集群上执行 kubectl get cm certs -n tke -o yaml 将 ca.crt 内容保存到客户端节点的/etc/docker/certs.d/<strong>**</strong>/ca.crt ( 为镜像仓库地址) 重启docker即可</p><h3 id=方法二>方法二：</h3><p>在/etc/docker/daemon.json文件里添加insecure-registries，如下： { &ldquo;insecure-registries&rdquo;: [ &ldquo;xxx&rdquo;,&ldquo;xxx&rdquo; ] } （<em>*</em> 为镜像仓库地址）</p><p>重启docker即可</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/tkestack/tke aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The TKEStack Authors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/web/js/main.min.1911ee3ae98d7d6df3807cd00d8e31ae7d1c08ee0f0bb587529b0483da4e5464.js integrity="sha256-GRHuOumNfW3zgHzQDY4xrn0cCO4PC7WHUpsEg9pOVGQ=" crossorigin=anonymous></script></body></html>