<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/web/zh/docs/user-guide/platform-console/operation-mgmt/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/web/favicons/favicon.ico><link rel=apple-touch-icon href=/web/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/web/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/web/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/web/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/web/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/web/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/web/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/web/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/web/favicons/android-192x192.png sizes=192x192><title>运维中心 | Tkestack</title><meta name=description content="生产级别多集群管理系统"><meta property="og:title" content="运维中心"><meta property="og:description" content="运维中心
"><meta property="og:type" content="website"><meta property="og:url" content="/web/zh/docs/user-guide/platform-console/operation-mgmt/"><meta property="og:site_name" content="Tkestack"><meta itemprop=name content="运维中心"><meta itemprop=description content="运维中心
"><meta name=twitter:card content="summary"><meta name=twitter:title content="运维中心"><meta name=twitter:description content="运维中心
"><link rel=preload href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css as=style><link href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/web/zh/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Tkestack</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/docs/><span>Docs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/blog/><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文 Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/web/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/web/zh/docs/user-guide/platform-console/operation-mgmt/>返回本页常规视图</a>.</p></div><h1 class=title>运维中心</h1><div class=lead>运维中心</div><ul><li>1: <a href=#pg-c33fc9e02cdad664bbb84e3fffcf6b82>Helm应用</a></li><li>2: <a href=#pg-26d04226b313f47a8e04a3e9fee4bd6e>日志采集</a></li><li>3: <a href=#pg-771091872cb56b9e533c1ead93c239a3>审计记录</a></li><li>4: <a href=#pg-4fbbc556a6db65b71e6c43d79c98e91f>事件持久化</a></li></ul><div class=content><h1 id=运维中心>运维中心</h1><h2 id=概念>概念</h2><p><strong>这里用户可以管理 Helm 应用、日志和集群事件持久化。</strong></p></div></div><div class=td-content><h1 id=pg-c33fc9e02cdad664bbb84e3fffcf6b82>1 - Helm应用</h1><div class=lead>Helm应用</div><p>应用功能是 TKEStack 集成的 <a href=https://helm.sh/>Helm 3.0</a> 相关功能，为您提供创建 helm chart、容器镜像、软件服务等各种产品和服务的能力。已创建的应用将在您指定的集群中运行，为您带来相应的能力。</p><h2 id=新建-helm-应用>新建 Helm 应用</h2><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【运维中心】->【 Helm 应用】</li><li>选择相应【集群】，单击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/platformhelm.png alt="&#x65B0;&#x5EFA; Helm &#x6309;&#x94AE;"></p><ul><li>在“新建 Helm 应用”页面填写Helm应用信息，如下图所示：</li></ul><p><img src=../../../../../images/%E6%96%B0%E5%BB%BAHelm%E5%BA%94%E7%94%A8.png alt="&#x65B0;&#x5EFA; Helm &#x5E94;&#x7528;"></p><ul><li><strong>应用名称：</strong> 输入应用名，1～63字符，只能包含小写字母、数字及分隔符("-")，且必须以小写字母开头，数字或小写字母结尾</li><li><strong>运行集群：</strong> 选择应用所在集群</li><li><strong>命名空间：</strong> 选择应用所在集群的命名空间</li><li><strong>类型：</strong> 当前仅支持 HelmV3</li><li><strong>Chart：</strong> 选择需要部署的 chart</li><li><strong>Chart版本：</strong> 选择 chart 的版本</li><li><strong>参数：</strong> 更新时如果选择不同版本的 Helm Chart，参数设置将被覆盖</li><li><strong>拟运行：</strong> 会返回模板渲染清单，即最终将部署到集群的 YAML 资源，不会真正执行安装</li><li>单击【完成】按钮</li></ul><h2 id=删除-helm-应用>删除 Helm 应用</h2><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【运维中心】->【 Helm 应用】</li><li>点击【删除】</li></ul><p><img src=../../../../../images/image-20201203150729694.png alt=image-20201203150729694></p><h2 id=查看-helm-应用资源列表>查看 Helm 应用资源列表</h2><ol><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【运维中心】->【 Helm 应用】</li><li>点击【应用名】后，点击【资源列表】，可查看该应用所有 Kubernetes 资源对象</li></ol><h2 id=查看-helm-应用详情>查看 Helm 应用详情</h2><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【运维中心】->【 Helm 应用】</li><li>点击【应用名】后，点击【应用详情】</li></ul><p><img src=../../../../../images/image-20201203150904452.png alt=image-20201203150904452></p><h2 id=查看-helm-应用版本历史>查看 Helm 应用版本历史</h2><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【运维中心】->【 Helm 应用】</li><li>点击【应用名】后，点击【版本历史】，可查看该应用所部署的历史版本。可以通过选择不同的版本进行参数对比查看其版本区别</li></ul><p><img src=../../../../../images/image-20201203151027616.png alt=image-20201203151027616></p></div><div class=td-content style=page-break-before:always><h1 id=pg-26d04226b313f47a8e04a3e9fee4bd6e>2 - 日志采集</h1><div class=lead>日志采集</div><h2 id=日志采集>日志采集</h2><h3 id=概念>概念</h3><p>TKESTack 提供的集群内日志采集功能，支持将集群内服务或集群节点特定路径文件的日志发送至 Kafka、Elasticsearch 等消费端，支持采集容器标准输出日志，容器内文件日志以及主机内文件日志。更提供事件持久化、审计等功能，实时记录集群事件及操作日志记录，帮助运维人员存储和分析集群内部资源生命周期、资源调度、异常告警等情况。</p><p><img src=../../../../../images/image%20%2830%29.png alt></p><p>日志收集功能需要为每个集群手动开启。日志收集功能开启后，日志收集组件 logagent 会在集群内以 Daemonset 的形式运行。用户可以通过日志收集规则配置日志的采集源和消费端，日志收集 Agent 会从用户配置的采集源进行日志收集，并将日志内容发送至用户指定的消费端。需要注意的是，使用日志收集功能需要您确认 Kubernetes 集群内节点能够访问日志消费端。</p><ul><li><strong>采集容器标准输出日志</strong> ：采集集群内指定容器的标准输出日志，采集到的日志信息将会以 JSON 格式输出到用户指定的消费端，并会自动附加相关的 Kubernetes metadata， 包括容器所属 pod 的 label 和 annotation 等信息。</li><li><strong>采集容器内文件日志</strong> ：采集集群内指定 pod 内文件的日志，用户可以根据自己的需求，灵活的配置所需的容器和路径，采集到的日志信息将会以 JSON 格式输出到用户指定的消费端， 并会附加相关的 Kubernetes metadata，包括容器所属 pod 的 label 和 annotation 等信息。</li><li><strong>采集主机内文件日志</strong> ：采集集群内所有节点的指定主机路径的日志，logagent 会采集集群内所有节点上满足指定路径规则的文件日志，以 JSON 格式输出到用户指定的输出端， 并会附加用户指定的 metadata，包括日志来源文件的路径和用户自定义的 metadata。</li></ul><blockquote><p>注意：日志采集对接外部 Kafka 或 Elasticsearch，该功能需要额外开启，位置在集群 <a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/products/platform/cluster.md#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF>基本信息</a> 下面，点击开启“日志采集”服务。</p></blockquote><p>​</p><p><img src=../../../../../images/image%20%28137%29.png alt></p><h3 id=新建日志采集规则>新建日志采集规则</h3><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【运维中心】->【日志采集】</li><li>选择相应【集群】和【命名空间】，单击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28119%29.png alt></p><ul><li>在“新建日志采集”页面填写日志采集信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2887%29.png alt></p><ul><li><strong>收集规则名称：</strong> 输入规则名，1～63字符，只能包含小写字母、数字及分隔符("-")，且必须以小写字母开头，数字或小写字母结尾</li><li><strong>所属集群：</strong> 选择所属集群</li><li><strong>类型：</strong> 选择采集类型<ul><li><strong>容器标准输出：</strong> 容器Stdout信息采集<ul><li><strong>日志源：</strong> 可以选择所有容器或者某个namespace下的所有容器/工作负载<ul><li><strong>所有容器：</strong> 所有容器</li><li><strong>指定容器：</strong> 某个Namespace下的所有容器或者工作负载</li></ul></li></ul></li><li><strong>容器文件路径：</strong> 容器内文件内容采集<ul><li><strong>日志源：</strong> 可以采集具体容器内的某个文件路径下的文件内容<ul><li><strong>工作负载选项：</strong> 选择某个namespace下的某种工作负载类型下的某个工作负载</li><li><strong>配置采集路径：</strong> 选择某个容器下的某个文件路径</li></ul></li></ul></li><li><strong>节点文件路径：</strong> 收集节点上某个路径下的文件内容<ul><li><strong>日志源：</strong><ul><li><strong>收集路径：</strong> 节点上日志收集路径</li><li><strong>metadata：</strong> key：value格式，收集的日志会带上metadata信息上报给消费端</li></ul></li></ul></li></ul></li><li><strong>消费端：</strong> 选择日志消费端<ul><li><p><strong>Kafka：</strong></p><ul><li><strong>访问地址：</strong> kafka ip 和端口</li><li><strong>主题（Topic）：</strong> kafka topic 名</li></ul></li><li><p><strong>Elasticsearch：</strong></p><blockquote><p>注意：当前只支持未开启用户登录认证的 ES 集群</p></blockquote><ul><li><strong>Elasticsearch地址：</strong> ES 地址，如：<a href=http://190.0.0.1:200/>http://190.0.0.1:200</a></li><li><strong>索引：</strong> ES索引，最长60个字符，只能包含小写字母、数字及分隔符("-"、"_"、"+")，且必须以小写字母开头</li></ul></li></ul></li><li>单击【完成】按钮</li></ul><h3 id=指定容器运行后的日志目录>指定容器运行后的日志目录</h3><p>LogAgent 除了支持日志规则的创建，也支持指定容器运行后的日志目录，可实现日志文件展示和下载。</p><blockquote><p>前提：需要在创建负载时挂载数据卷，并指定日志目</p></blockquote><p><img src=../../../../../images/image%20%28102%29.png alt></p><p>创建负载以后，在<code>/data/logdir</code>目录下的所有文件可以展示并下载，不仅是日志文件，例如我们在容器的<code>/data/logdir</code>下新建一个名为<code>a.log</code>的文件，如果有内容的话，也可以在这里展示与下载</p><p><img src=../../../../../images/image%20%2886%29.png alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-771091872cb56b9e533c1ead93c239a3>3 - 审计记录</h1><div class=lead>审计记录</div><h2 id=简介>简介</h2><p>TKEStack 集群审计是基于 <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/audit>Kubernetes Audit</a> 对 kube-apiserver 产生的可配置策略的 JSON 结构日志的记录存储及检索功能。本功能记录了对 kube-apiserver 的访问事件，会按顺序记录每个用户、管理员或系统组件影响集群的活动。</p><h3 id=功能优势>功能优势</h3><p>集群审计功能提供了区别于 metrics 的另一种集群观测维度。开启 TKEStack 集群审计后，<strong>会在集群里的 tke 命名空间下生成 tke-audit-api 的 Deployment</strong>，Kubernetes 可以记录每一次对集群操作的审计日志。每一条审计日志是一个 JSON 格式的结构化记录，包括元数据（metadata）、请求内容（requestObject）和响应内容（responseObject）三个部分。其中元数据（包含了请求的上下文信息，例如谁发起的请求、从哪里发起的、访问的 URI 等信息）一定会存在，请求和响应内容是否存在取决于审计级别。通过日志可以了解到以下内容：</p><ul><li>集群里发生的活动</li><li>活动的发生时间及发生对象。</li><li>活动的触发时间、触发位置及观察点</li><li>活动的结果以及后续处理行为</li></ul><h3 id=阅读审计日志>阅读审计日志</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>{
  &#34;kind&#34;:&#34;Event&#34;,
  &#34;apiVersion&#34;:&#34;audit.k8s.io/v1&#34;,
  &#34;level&#34;:&#34;RequestResponse&#34;,
  &#34;auditID&#34;:0a4376d5-307a-4e16-a049-24e017******,
  &#34;stage&#34;:&#34;ResponseComplete&#34;,
  // 发生了什么
  &#34;requestURI&#34;:&#34;/apis/apps/v1/namespaces/default/deployments&#34;,
  &#34;verb&#34;:&#34;create&#34;,
  // 谁发起的
  &#34;user&#34;:{
    &#34;username&#34;:&#34;admin&#34;,
      &#34;uid&#34;:&#34;admin&#34;,
      &#34;groups&#34;:[
        &#34;system:masters&#34;,
        &#34;system:authenticated&#34;
      ]
  },
  // 从哪里发起
  &#34;sourceIPs&#34;:[
    &#34;10.0.6.68&#34;
  ],
  &#34;userAgent&#34;:&#34;kubectl/v1.16.3 (linux/amd64) kubernetes/ald64d8&#34;,
  // 发生了什么
  &#34;objectRef&#34;:{
    &#34;resource&#34;:&#34;deployments&#34;,
    &#34;namespace&#34;:&#34;default&#34;,
    &#34;name&#34;:&#34;nginx-deployment&#34;,
    &#34;apiGroup&#34;:&#34;apps&#34;,
    &#34;apiVersion&#34;:&#34;v1&#34;
  },
  // 结果是什么
  &#34;responseStatus&#34;:{
    &#34;metadata&#34;:{
    },
    &#34;code&#34;:201
  },
  // 请求及返回具体信息
  &#34;requestObject&#34;:Object{...},
  &#34;responseObject&#34;:Object{...},
  // 什么时候开始/结束
  &#34;requestReceivedTimestamp&#34;:&#34;2020-04-10T10:47:34.315746Z&#34;,
  &#34;stageTimestamp&#34;:&#34;2020-04-10T10:47:34.328942Z&#34;,
  // 请求被接收/拒绝的原因是什么
  &#34;annotations&#34;:{
    &#34;authorization.k8s.io/decision&#34;:&#34;allow&#34;,
    &#34;authorization.k8s.io/reason&#34;:&#34;&#34;
  }
}
</code></pre></div><h2 id=前提条件>前提条件</h2><blockquote><p>在 <a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/installation/installation-procedures.md>Installer 安装页面</a>的控制台安装的第5步中，如下图所示，已经开启平台审计功能，并配置好 ElasticSearch：</p></blockquote><h2 id=查看审计>查看审计</h2><ol><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【运维中心】->【审计记录】，查看审计列表：</li></ol><p><img src=../../../../../images/image%20%2821%29.png alt></p><h2 id=参考>参考</h2><p>TKEStack 关于审计的相关配置：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># kube-apiserver 地址：/etc/kubernetes/manifests/kube-apiserver.yaml

--audit-policy-file=/etc/kubernetes/audit-policy.yaml # 审计策略
--audit-webhook-config-file=/etc/kubernetes/audit-api-client-config.yaml # 指定 Webhook backend 的配置文件

# 获取 TKEStack 审计组件的详细信息
kubectl describe deploy -ntke tke-audit-api 

# 获取 TKEStack 审计的相关配置
kubectl describe cm -ntke tke-audit-api 
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4fbbc556a6db65b71e6c43d79c98e91f>4 - 事件持久化</h1><div class=lead>事件持久化</div><h2 id=persistentevent>PersistentEvent</h2><h3 id=persistentevent-介绍>PersistentEvent 介绍</h3><p>Kubernetes Events 包括了 Kuberntes 集群的运行和各类资源的调度情况，对维护人员日常观察资源的变更以及定位问题均有帮助。TKEStack 支持为您的所有集群配置事件持久化功能，开启本功能后，会将您的集群事件实时导出到 ElasticSearch 的指定索引。</p><h4 id=persistentevent-使用场景>PersistentEvent 使用场景</h4><p>Kubernetes 事件是集群内部资源生命周期、资源调度、异常告警等情况产生的记录，可以通过事件深入了解集群内部发生的事情，例如调度程序做出的决策或者某些pod从节点中被逐出的原因。</p><p>kubernetes 默认仅提供保留一个小时的 kubernetes 事件到集群的 ETCD 里。 PersistentEvent 提供了将 Kubernetes 事件持久化存储的前置功能，允许您通过PersistentEvent 将集群内事件导出到您自有的存储端。</p><h4 id=persistentevent-限制条件>PersistentEvent 限制条件</h4><ol><li><strong>注意：当前只支持版本号为5的 ElasticSearch，且未开启 ElasticSearch 集群的用户登录认证</strong></li><li>安装 PersistentEvent 将占用集群0.2核 CPU,100MB 内存的资源</li><li>仅在1.8版本以上的 kubernetes 集群支持</li></ol><h4 id=部署在集群内kubernetes对象>部署在集群内kubernetes对象</h4><p>在集群内部署PersistentEvent Add-on , 将在集群内部署以下kubernetes对象</p><table><thead><tr><th style=text-align:left>kubernetes对象名称</th><th style=text-align:left>类型</th><th style=text-align:left>默认占用资源</th><th style=text-align:left>所属Namespaces</th></tr></thead><tbody><tr><td style=text-align:left>tke-persistent-event</td><td style=text-align:left>deployment</td><td style=text-align:left>0.2核CPU,100MB内存</td><td style=text-align:left>kube-system</td></tr></tbody></table><h3 id=persistentevent-使用方法>PersistentEvent 使用方法</h3><h4 id=在-扩展组件-里使用>在 扩展组件 里使用</h4><ol><li><p>登录 TKEStack</p></li><li><p>切换至【平台管理】控制台，选择 【扩展组件】，选择需要安装事件持久化组件的集群，安装 PersistentEvent 组件，注意安装 PersistentEvent 时需要在页面下方指定 ElasticSearch 的地址和索引</p><blockquote><p>注意：当前只支持版本号为5，且未开启用户登录认证的 ES 集群</p></blockquote></li></ol><h4 id=在-运维中心-里使用>在 运维中心 里使用</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【运维中心】->【事件持久化】，查看事件持久化列表</li><li>单击列表最右侧【设置】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28114%29.png alt></p><ul><li>在“设置事件持久化”页面填写持久化信息<ul><li><p><strong>事件持久化存储：</strong> 是否进行持久化存储</p><blockquote><p>注意：当前只支持版本号为5，且未开启用户登录认证的 ES 集群</p></blockquote></li><li><p><strong>Elasticsearch地址：</strong> ES 地址，如：<a href=http://190.0.0.1:200/>http://190.0.0.1:200</a></p></li><li><p><strong>索引：</strong> ES索引，最长60个字符，只能包含小写字母、数字及分隔符("-"、"_"、"+")，且必须以小写字母开头</p></li></ul></li><li>单击【完成】按钮</li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/tkestack/tke aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The TKEStack Authors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/web/js/main.min.1911ee3ae98d7d6df3807cd00d8e31ae7d1c08ee0f0bb587529b0483da4e5464.js integrity="sha256-GRHuOumNfW3zgHzQDY4xrn0cCO4PC7WHUpsEg9pOVGQ=" crossorigin=anonymous></script></body></html>