<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/web/zh/docs/user-guide/platform-console/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/web/favicons/favicon.ico><link rel=apple-touch-icon href=/web/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/web/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/web/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/web/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/web/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/web/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/web/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/web/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/web/favicons/android-192x192.png sizes=192x192><title>平台管理控制台 | Tkestack</title><meta name=description content="生产级别多集群管理系统"><meta property="og:title" content="平台管理控制台"><meta property="og:description" content="平台管理控制台
"><meta property="og:type" content="website"><meta property="og:url" content="/web/zh/docs/user-guide/platform-console/"><meta property="og:site_name" content="Tkestack"><meta itemprop=name content="平台管理控制台"><meta itemprop=description content="平台管理控制台
"><meta name=twitter:card content="summary"><meta name=twitter:title content="平台管理控制台"><meta name=twitter:description content="平台管理控制台
"><link rel=preload href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css as=style><link href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/web/zh/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Tkestack</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/docs/><span>Docs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/blog/><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文 Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/web/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/web/zh/docs/user-guide/platform-console/>返回本页常规视图</a>.</p></div><h1 class=title>平台管理控制台</h1><div class=lead>平台管理控制台</div><ul><li>1: <a href=#pg-244fe30a59f1efe2a63093adc1d95f1d>概览</a></li><li>2: <a href=#pg-8a8e3c823159d27959aba112514409fb>集群管理</a></li><li>3: <a href=#pg-4084130a4de3422093300679bfcd6e9d>业务管理</a></li><li>4: <a href=#pg-2eac969bd1933c41613cedbe9af4c914>扩展组件</a></li><ul><li>4.1: <a href=#pg-f8882211bf86e03e9ad6a7593f6389f4>TApp 介绍</a></li><li>4.2: <a href=#pg-36486ddbc5cae072d21407bccf243040>CronHPA 介绍</a></li><li>4.3: <a href=#pg-10c69052f011daaf2098d301331d233d>监控组件</a></li><li>4.4: <a href=#pg-6dcd138c670444e4d6bd8c3e521b6e9d>LogAgent 介绍</a></li><li>4.5: <a href=#pg-901ced327a8b1d8464a48213006e87cc>GPUManager 介绍</a></li><li>4.6: <a href=#pg-1908a7f2ad115ef0bc6b1cde68a4cc21>CSIOperator 介绍</a></li></ul><li>5: <a href=#pg-d5c510eb12ae466242386f0cebdb156b>组织资源</a></li><ul><li>5.1: <a href=#pg-64d4646ef1291f0db93a3686d23ec15f>镜像仓库管理</a></li><li>5.2: <a href=#pg-26f3f5de560aa7df709ac0f6721cad7a>Helm模板</a></li><li>5.3: <a href=#pg-e90c4b8de7956382e8cb823e234fcfdc>访问凭证</a></li></ul><li>6: <a href=#pg-1e2e6f8e38db1566b319ae4dcf54e5bd>访问管理</a></li><ul><li>6.1: <a href=#pg-2afb350b927ffbe1b6aefc8291b4faba>策略管理</a></li><li>6.2: <a href=#pg-b8df25d88d18c9314eee7073f7e19ed4>用户管理</a></li></ul><li>7: <a href=#pg-b22c0bde169ab6bdc225b49782930706>监控&告警</a></li><ul><li>7.1: <a href=#pg-23a8b7f582c270bcb790b3707905d346>告警记录</a></li><li>7.2: <a href=#pg-c677185f730a103f7429f6161d3c5546>通知设置</a></li><li>7.3: <a href=#pg-0a1a33c9e3221ae15fbb22a45f0ce01a>告警设置</a></li></ul><li>8: <a href=#pg-09ccc45f60cc4e226d68fd40cba886e8>运维中心</a></li><ul><li>8.1: <a href=#pg-c33fc9e02cdad664bbb84e3fffcf6b82>Helm应用</a></li><li>8.2: <a href=#pg-26d04226b313f47a8e04a3e9fee4bd6e>日志采集</a></li><li>8.3: <a href=#pg-771091872cb56b9e533c1ead93c239a3>审计记录</a></li><li>8.4: <a href=#pg-4fbbc556a6db65b71e6c43d79c98e91f>事件持久化</a></li></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-244fe30a59f1efe2a63093adc1d95f1d>1 - 概览</h1><div class=lead>概览</div><p>平台概览页面，可查看TKEStack控制台管理资源的概览。</p><p>如下图所示，在【平台管理】页面点击【概览】，此处可以展现：</p><ol><li>平台的资源概览</li><li>集群的资源状态</li><li>快速入口</li><li>实用提示</li></ol><p><img src=../../../../images/overview.png alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8a8e3c823159d27959aba112514409fb>2 - 集群管理</h1><div class=lead>集群管理</div><h2 id=概念>概念</h2><p><strong>在这里可以管理你的 Kubernetes 集群</strong></p><p><img src=../../../../images/1588923397_72_w857_h868.png alt=img></p><p>平台安装之后，可在【平台管理】控制台的【集群管理】中看到 global 集群，如下图所示： <img src=../../../../images/cluster%20%282%29%20%282%29%20%285%29.png alt=Global&#x96C6;&#x7FA4;></p><p>TKEStack还可以另外<strong>新建独立集群</strong>以及<strong>导入已有集群</strong>实现<strong>多集群的管理</strong></p><blockquote><p>注意：<strong>新建独立集群</strong>和<strong>导入已有集群</strong>都属于<a href=../../../installation/installation-architecture>TKEStack架构</a>中的<strong>业务集群</strong>。</p></blockquote><h2 id=新建独立集群>新建独立集群</h2><ol><li><p>登录 TKEStack，右上角会出现当前登录的用户名，示例为admin</p></li><li><p>切换至【平台管理】控制台</p></li><li><p>在“集群管理”页面中，单击【新建独立集群】，如下图所示：</p><p><img src=../../../../images/createCluster.png alt=&#x65B0;&#x5EFA;&#x72EC;&#x7ACB;&#x96C6;&#x7FA4;></p></li><li><p>在“新建独立集群”页面，填写集群的基本信息。新建的集群节点需满足<a href=https://github.com/ruyingzhe/docs/tree/7f24a45c0f07eac673325093def1526590391c03/docs/installation/installation-requirement.md>部署环境要求</a>，在满足需求之后，TKEStack的集群添加非常便利。如下图所示,只需填写【集群名称】、【目标机器】、【SSH端口】（默认22）、【密码】，其他保持默认即可添加新的集群。</p><blockquote><p>注意：若【保存】按钮是灰色，单击页面空白处即可变蓝</p></blockquote><p><img src=../../../../images/ClusterInfo.png alt=&#x96C6;&#x7FA4;&#x57FA;&#x672C;&#x4FE1;&#x606F;0.png></p><ul><li><p><strong>集群名称：</strong> 支持<strong>中文</strong>，小于60字符即可</p></li><li><p><strong>Kubernetes版本：</strong> 选择合适的kubernetes版本，各版本特性对比请查看 <a href=https://kubernetes.io/docs/home/supported-doc-versions/>Supported Versions of the Kubernetes Documentation</a>（<strong>建议使用默认值</strong>）</p></li><li><p><strong>网卡名称：</strong> 可以通过 ifconfig 查看设备的网卡名称，一般默认都是 eth0。但有一些特殊情况：如果非 eth0 一定要填入正确的网卡名称，否则跨设备通信容易出现问题</p></li><li><p><strong>高可用类型</strong> ：高可用 VIP 地址（<strong>按需使用</strong>）</p><blockquote><p>注意：如果使用高可用，至少需要三个 master 节点才可组成高可用集群，否则会出现 <em><strong>脑裂</strong></em> 现象。</p></blockquote><ul><li><strong>不设置</strong>：第一台 master 节点的 IP 地址作为 APIServer 地址</li></ul></li><li><p><strong>TKE 提供</strong>：用户只需提供高可用的 IP 地址。TKE 部署 Keepalive，配置该 IP 为 Global 集群所有 Master 节点的VIP，以实现 Global 集群和控制台的高可用，此时该 VIP 和所有 Master 节点 IP 地址都是 APIServer 地址</p><ul><li><strong>使用已有</strong>：对接配置好的外部 LB 实例。VIP 绑定 Global 集群所有 Master 节点的 80（TKEStack 控制台）、443（TKEStack 控制台）、6443（kube-apiserver 端口）、31138（tke-auth-api 端口）端口，同时确保该 VIP 有至少两个 LB 后端（Master 节点），以避免 LB 单后端不可用风险</li></ul></li><li><p><strong>GPU</strong>：选择是否安装 GPU 相关依赖。（<strong>按需使用</strong>）</p><blockquote><p>注意：使用 GPU 首先确保节点有物理 GPU 卡，选择 GPU 类型后，平台将自动为节点安装相应的 GPU 驱动和运行时工具</p></blockquote><ul><li><strong>pGPU</strong>：平台会自动为集群安装 <a href=https://github.com/tkestack/docs/blob/master/features/gpumanager.md>GPUManager</a> 扩展组件，此时可以给负载分配任意整数张卡</li><li><strong>vGPU</strong>：平台会自动为集群安装 <a href=https://github.com/NVIDIA/k8s-device-plugin>Nvidia-k8s-device-plugin</a>，此时GPU可以被虚拟化，可以给负载分配非整数张GPU卡，例如可以给一个负载分配0.3个GPU</li></ul></li><li><p><strong>容器网络</strong> ：将为集群内容器分配在容器网络地址范围内的 IP 地址，您可以自定义三大私有网段作为容器网络， 根据您选择的集群内服务数量的上限，自动分配适当大小的 CIDR 段用于 kubernetes service；根据您选择 Pod 数量上限/节点，自动为集群内每台云服务器分配一个适当大小的网段用于该主机分配 Pod 的 IP 地址。（<strong>建议使用默认值</strong>）</p><ul><li><strong>CIDR：</strong> 集群内 Sevice、 Pod 等资源所在网段，注意：CIDR不能与目标机器IP段重叠， 否则会造成初始化失败</li><li><strong>Pod数量上限/节点：</strong> 决定分配给每个 Node 的 CIDR 的大小</li><li><strong>Service数量上限/集群</strong>：决定分配给 Sevice 的 CIDR 大小</li></ul></li><li><p><strong>Master</strong> ：输入目标机器信息后单击保存，<strong>若保存按钮是灰色，单击网页空白处即可变蓝</strong></p><blockquote><p>注意：如果在之前选择了高可用，至少需要三个 master 节点才可组成高可用集群，否则会出现 <em><strong>脑裂</strong></em> 现象。</p></blockquote><ul><li><p><strong>目标机器</strong>：Master 节点<strong>内网 IP</strong>，请配置<strong>至少 8 Cores & 16G 内存</strong> 及以上的机型，<strong>否则会部署失败</strong>。注意：如上图所示，如果节点密码一样，这里可以通过英文的分号“;”分隔多个 IP 地址实现快速添加多个节点</p></li><li><p><strong>SSH 端口</strong>： 请确保目标机器安全组开放 22 端口和 ICMP 协议，否则无法远程登录和 ping 通云服务器。（<strong>建议使用默认值22</strong>）</p></li><li><p><strong>主机label</strong>：给主机设置 Label,可用于指定容器调度。（<strong>按需使用</strong>）</p></li><li><p><strong>认证方式</strong>：连接目标机器的方式</p><ul><li><strong>密码认证</strong>：<ul><li><strong>密码</strong>：目标机器密码</li></ul></li><li><strong>密钥认证</strong>：<ul><li><strong>密码</strong>：目标机器密码</li><li><strong>证书</strong>：目标机器登陆证书</li></ul></li></ul></li><li><p><strong>GPU</strong>： 使用 GPU 机器需提前安装驱动和 runtime。（<strong>按需使用</strong>）</p><blockquote><p><strong>添加机器</strong>：可以通过节点下面的**【添加】**蓝色字体增加不同密码的master节点（**按需添加**）</p></blockquote></li></ul></li></ul></li><li><p><strong>提交</strong>： 集群信息填写完毕后，【提交】按钮变为可提交状态，单击即可提交。</p></li></ol><h2 id=导入已有集群>导入已有集群</h2><ol><li>登录 TKEStack</li><li>切换至【平台管理】控制台</li><li>在“集群管理”页面，单击【导入集群】，如下图所示： <img src=../../../../images/importCluster-1.png alt=&#x5BFC;&#x5165;&#x96C6;&#x7FA4;></li><li>在“导入集群”页面，填写被导入的集群信息，如下图所示： <img src=../../../../images/importCluster-2.png alt=&#x5BFC;&#x5165;&#x96C6;&#x7FA4;&#x4FE1;&#x606F;><ul><li><p><strong>名称</strong>： 被导入集群的名称，最长60字符</p></li><li><p><strong>API Server</strong>： 被导入集群的 API Server 的域名或 IP 地址</p></li><li><p><strong>CertFile</strong>： 输入被导入集群的 CertFile 文件内容</p></li><li><p><strong>Token</strong>： 输入被导入集群创建时的 token 值</p><blockquote><p>注意：若不清楚集群的这些信息如何获取，可以参照下面导入 TKE/ACK/RKE 的方式导入自己的集群。</p></blockquote></li></ul></li><li>单击最下方 【提交】 按钮</li></ol><h4 id=tkestack-导入腾讯的-tke-集群>TKEStack 导入腾讯的 TKE 集群</h4><ol><li><p>首先需要在 TKE 控制台所要导入的集群“基本信息”页里开启内/外网访问</p><p><img src=https://github.com/ruyingzhe/docs/tree/7f24a45c0f07eac673325093def1526590391c03/docs/images/image-20200930154323734.png alt=image-20200930154323734></p></li><li><p><strong>APIServer 地址</strong>：即上图中的访问地址，也可以根据上图中 kubeconfig 文件里的“server”字段内容填写。</p></li><li><p><strong>CertFile</strong>：集群证书，kubeconfig 中“certificate-authority-data”字段内容。</p></li><li><p><strong>Token</strong>：由于目前 TKE 没有自动创建具有 admin 权限的 token，这里需要手动创建，具体方式如下：</p><ol><li><p>生成 kubernetes 集群最高权限 admin 用户的 token</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#000>cat &lt;&lt;EOF | kubectl apply -f -</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterRoleBinding</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rbac.authorization.kubernetes.io/autoupdate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>roleRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterRole</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>apiGroup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>subjects</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kube-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kube-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes.io/cluster-service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>addonmanager.kubernetes.io/mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Reconcile</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>EOF</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li><li><p>创建完成后获取 secret 中 token 的值</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># 获取admin-token的secret名字
$ kubectl -n kube-system get secret|grep admin-token
admin-token-nwphb                          kubernetes.io/service-account-token   3         6m
# 获取token的值
$ kubectl -n kube-system describe secret admin-token-nwphb | grep token
Name:         admin-token-w4wcd
Type:  kubernetes.io/service-account-token
token:            非常长的字符串
</code></pre></div></li></ol></li></ol><h4 id=tkestack-中导入-rancher-的-rke-集群>TKEStack 中导入 Rancher 的 RKE 集群</h4><blockquote><p>特别注意：RKE 集群的 kubeconfig 中 clusters 字段里面的第一个 cluster 一般都是 Rancher 平台，而不是 RKE 集群。输入以下信息时，要确定选择正确的集群。</p></blockquote><ol><li><p>获取 RKE 的 kubeconfig 文件</p></li><li><p><strong>APIServer 地址</strong>：获取文件里面的“cluster”字段下“server”的内容。注意是引号里的全部内容</p></li><li><p><strong>CertFile</strong>：集群证书，在上面的“server”地址的正下方，有集群证书字段“certificate-authority-data”。</p><blockquote><p>注意，Rancher 的 kubeconfig 这里的字段内容默认有“\”换行符，需要手动把内容里的换行符和空格全部去除。</p></blockquote></li><li><p><strong>Token</strong>：在“user”字段里面拥有用户的 token</p></li></ol><h4 id=tkestack-中导入阿里的-ack-集群>TKEStack 中导入阿里的 ACK 集群</h4><ol><li>和 TKE 一样，需要获取开启外网访问的 ACK 的 kubeconfig 文件</li><li><strong>APIServer 地址</strong>：获取文件里面的“cluster”字段下“server”的内容</li><li><strong>CertFile</strong>：集群证书，在上面的“server”地址正下方有集群证书字段“certificate-authority-data”</li><li><strong>Token</strong>：获取方式同 TKE，需要手动创建</li></ol><h2 id=对集群的操作><strong>对集群的操作</strong></h2><h3 id=基本信息>基本信息</h3><ol><li><p>登录 TKEStack</p></li><li><p>切换至【平台管理】控制台</p></li><li><p>在“集群管理”页面中，点击要操作的集群ID，如下图“global”所示：</p><p><img src=../../../../images/cluster%20%282%29%20%282%29%20%282%29.png alt=Global&#x96C6;&#x7FA4;></p></li><li><p>点击【基本信息】，可查看集群基础信息</p><p><img src=../../../../images/basicinformation.png alt></p><ol><li><strong>基本信息</strong><ol><li><strong>集群名称</strong>：用户自定义，可以通过第3步“集群列表页”中 “ID/名称” 下的笔型图案修改</li><li><strong>集群 ID</strong> ：TKEStack 自动给每个集群一个唯一的 ID 标识符</li><li><strong>状态</strong>：集群运行状态，Running 表示正常运行</li><li><strong>Kubernetes 版本</strong>：当前集群的 Kubernetes 版本</li><li><strong>网卡名称</strong>：当前集群的网卡名称，默认为 eth0</li><li><strong>容器网络</strong>：当前集群的容器网络</li><li><strong>集群凭证</strong>：可以在本地配置 Kubectl 连接 当前 Kubernetes 集群</li><li><strong>超售比</strong>：Kubernetes 对象在申请资源时，如果申请总额大于硬件配置，则无法申请，但是很多时候部分对象并没有占用这么多资源，因此可以设置超售比来扩大资源申请总额，以提高硬件资源利用率</li><li><strong>创建时间</strong>：当前集群的创建时间</li></ol></li><li><strong>组件信息</strong>：这里可以开启或关闭集群的 日志采集 和 监控告警 功能<ol><li><strong>监控告警</strong>：通过在集群安装 prometheus 实现，可以在【监控&告警】下的<a href=https://github.com/ruyingzhe/docs/tree/7f24a45c0f07eac673325093def1526590391c03/docs/user-guide/platform/monitor&alert/alertsetting.md>【告警设置】</a>进一步设置</li><li><strong>日志采集</strong>：通过在集群安装 logagent 实现，可以在【运维中心】下的<a href=https://github.com/ruyingzhe/docs/tree/7f24a45c0f07eac673325093def1526590391c03/docs/user-guide/platform/operation/log.md>【日志采集】</a>进一步设置</li></ol></li></ol></li></ol><h3 id=节点管理>节点管理</h3><p>节点是容器集群组成的基本元素。节点取决于业务，既可以是虚拟机，也可以是物理机。每个节点都包含运行 Pod 所需要的基本组件，包括 Kubelet、Kube-proxy 等。</p><h4 id=添加节点>添加节点</h4><ol><li><p>登录 TKEStack</p></li><li><p>切换至【平台管理】控制台</p></li><li><p>在“集群管理”页面中，点击要操作的集群ID，如下图“global”所示：</p><p><img src=../../../../images/cluster%20%282%29%20%282%29%20%286%29.png alt=Global&#x96C6;&#x7FA4;></p></li><li><p>点击【节点管理】中的【节点】，可查看当前集群的“节点列表”</p><p><img src=../../../../images/nodes.png alt></p></li><li><p>点击蓝色【添加节点】按钮可增加当前集群的 Worker 节点</p><ol><li>目标机器：建议内网地址，要求添加的节点和当前集群的其他机器在同一内网。注意：如果节点密码一样，这里可以通过英文的分号“;”分隔多个 IP 地址实现快速添加多个节点</li><li>SSH端口：默认 22</li><li>主机label：按需添加，给主机设置 Label，可用于指定容器调度</li><li>认证方式：连接目标机器的方式，根据实际情况设置</li><li>用户名：默认 root</li><li>密码：目标机器用户名为 root 的密码</li><li>GPU：按需选择，使用 GPU 机器需提前安装驱动和 runtime</li><li>添加机器：可以通过节点下面的**【添加】**蓝色字体增加不同密码的节点（按需添加）</li></ol></li></ol><h4 id=节点监控>节点监控</h4><p>点击上图中的蓝色【监控】按钮可监控节点，可以从Pod、CPU、内存、硬盘、网络等维度监控。</p><blockquote><p>前提：在集群的 <a href=cluster-mgmt.md#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF>基本信息</a> 页里开启了 监控告警</p></blockquote><h4 id=节点操作>节点操作</h4><p>对节点的可以的操作如下图所示：</p><p><img src=../../../../images/nodecaozuo.png alt></p><ol><li><p><strong>移出</strong>：仅针对 worker 节点，将节点移出集群</p></li><li><p><strong>驱逐</strong>：节点驱逐后，将会把节点内的所有 Pod（不包含 DaemonSet 管理的 Pod）从节点中驱逐到集群内其他节点，并将节点设置为封锁状态</p><blockquote><p>注意：本地存储的 Pod 被驱逐后数据将丢失，请谨慎操作</p></blockquote></li><li><p><strong>编辑标签</strong>：编辑节点标签</p></li><li><p><strong>编辑 Taint</strong>：编辑 Taint 后，新的 pod 不能被调度到该节点，但可以通过编辑 pod 的 toleration 使其可以调度到具有匹配的 taint 节点上</p></li><li><p><strong>封锁</strong>：封锁节点后，将不接受新的Pod调度到该节点，需要手动取消封锁的节点</p></li></ol><h4 id=节点-pod-管理>节点 Pod 管理</h4><p>点击其中一个节点名，例如上图中的【172.19.0.154】，可以看到该节点更多的信息，具体包括：</p><p><img src=../../../../images/nodespod.png alt></p><ol><li><strong>Pod 管理</strong>：可查看当前节点下的 pod<ol><li>销毁重建：销毁该 pod，重新新建该 pod</li><li>远程登录：登录到该 pod 里</li></ol></li><li><strong>事件</strong>：关于该节点上资源的事件，资源事件只在 ETCD 里保存最近1小时内发生的事件，请尽快查阅</li><li><strong>详情</strong>：包括节点主机信息以及 Kubernetes 信息</li><li><strong>YAML</strong>：此处可以查看节点的 YAML 文件，点击【编辑YAML】可以手动修改节点的 YAML 文件</li></ol><h3 id=其他操作>其他操作</h3><p>注意：由于【平台管理】控制台下对集群的大多数操作与【业务管理】控制台完全一致，因此除了集群的【基本信息】和【节点管理】之外，其他栏目（包括 命名空间、负载、服务、配置、存储、日志、事件）请参考【业务管理】控制台下<a href=https://github.com/ruyingzhe/docs/tree/7f24a45c0f07eac673325093def1526590391c03/docs/user-guide/business-control-pannel/application/README.md>【应用管理】</a>的相应部分。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4084130a4de3422093300679bfcd6e9d>3 - 业务管理</h1><div class=lead>业务管理</div><h2 id=概念>概念</h2><p><strong>在这里用户可以管理线上业务。</strong></p><h2 id=操作步骤>操作步骤</h2><h3 id=新建业务>新建业务</h3><blockquote><p>注：业务可以实现跨集群资源的使用</p></blockquote><ol><li><p>登录 TKEStack。</p></li><li><p>在【平台管理】控制台的【业务管理】中，单击 【新建业务】。如下图所示：</p><p><img src=../../../../images/createbusiness.png alt=&#x65B0;&#x5EFA;&#x4E1A;&#x52A1;></p></li><li><p>在“新建业务”页面，填写业务信息。如下图所示： <img src=../../../../images/bussinessInfo.png alt=&#x4E1A;&#x52A1;&#x4FE1;&#x606F;></p></li><li><p><strong>业务名称</strong>：不能超过63个字符，这里以<code>my-business</code>为例</p></li><li><p><strong>业务成员</strong>： <a href=access-mgmt/>【访问管理】</a>中【用户管理】中的用户，这里以<code>admin</code>例，即该用户可以访问这个业务。</p></li><li><p><strong>集群</strong>：</p><ul><li>【集群管理】中的集群，这里以<code>gobal</code>集群为例</li><li>【填写资源限制】可以设置当前业务使用该集群的资源上限（可不限制）</li><li>【新增集群】可以添加多个集群，此业务可以使用多个集群的资源（按需添加）</li></ul></li><li><p><strong>上级业务</strong>：支持多级业务管理，按需选择（可不选）</p></li><li><p>单击最下方 【完成】 按钮即可创建业务。</p></li></ol><h3 id=添加业务成员>添加业务成员</h3><ol><li><p>登录 TKEStack。</p></li><li><p>切换至 【平台管理】控制台，点击【业务管理】。</p></li><li><p>在“业务管理”页面中，可以看到已创建的业务列表。鼠标移动到要修改的业务上(无需点击)，成员列会出现修改图标按钮。如下图所示： <img src=../../../../images/%E4%BF%AE%E6%94%B9%E4%B8%9A%E5%8A%A1%E6%88%90%E5%91%98%E5%9B%BE%E6%A0%87.png alt=&#x4FEE;&#x6539;&#x56FE;&#x6807;&#x6309;&#x94AE;></p><blockquote><p>注意：修改业务成员仅限状态为Active的业务，这里可以新建和删除成员。</p></blockquote></li></ol><h3 id=查看业务监控>查看业务监控</h3><ol><li><p>登录 TKEStack。</p></li><li><p>切换至 【管理】控制台，点击【业务管理】。</p></li><li><p>在“业务管理”页面中，可以看到已创建的业务列表。点击监控按钮，如下图所示：</p><p><img src=../../../../images/%E6%9F%A5%E7%9C%8B%E4%B8%9A%E5%8A%A1%E7%9B%91%E6%8E%A7.png alt=&#x76D1;&#x63A7;&#x6309;&#x94AE;></p></li><li><p>在右侧弹出窗口里查看业务监控情况，如下图所示：</p><p><img src=../../../../images/%E4%B8%9A%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E6%83%85.png alt=&#x4E1A;&#x52A1;&#x76D1;&#x63A7;&#x8BE6;&#x60C5;></p></li></ol><h3 id=删除业务>删除业务</h3><ol><li><p>登录 TKEStack。</p></li><li><p>切换至 【平台管理】控制台，点击【业务管理】。</p></li><li><p>在“业务管理”页面中，可以看到已创建的业务列表。点击删除按钮，如下图所示：</p><p><img src=../../../../images/%E5%88%A0%E9%99%A4%E4%B8%9A%E5%8A%A1.png alt=&#x5220;&#x9664;&#x4E1A;&#x52A1;></p><blockquote><p>注意：删除业务成员仅限状态为Active的业务</p></blockquote></li></ol><h3 id=对业务的操作>对业务的操作</h3><ol><li><p>登录 TKEStack。</p></li><li><p>在【平台管理】控制台的【业务管理】中，单击【业务id】。如下图所示： <img src=../../../../images/businessid.png alt=&#x4E1A;&#x52A1;id></p><p>a. <strong>业务信息：</strong> 在这里可以对业务名称、关联的集群、关联集群的资源进行限制等操作。</p><p><img src=../../../../images/%E4%B8%9A%E5%8A%A1%E4%BF%A1%E6%81%AF1.png alt=&#x4E1A;&#x52A1;&#x4FE1;&#x606F;></p><p>b. <strong>成员列表：</strong> 在这里可以对业务名称、关联的集群、关联集群的资源进行限制等操作。</p><p><img src=../../../../images/%E6%88%90%E5%91%98%E5%88%97%E8%A1%A8%E8%AE%BE%E7%BD%AE.png alt=&#x4E1A;&#x52A1;&#x4FE1;&#x606F;></p><p>c. <strong>子业务：</strong> 在这里可以<strong>新建本业务的子业务</strong>或<strong>通过导入子业务将已有业务变成本业务的子业务</strong></p><p><img src=../../../../images/%E5%AD%90%E4%B8%9A%E5%8A%A1.png alt=&#x4E1A;&#x52A1;&#x4FE1;&#x606F;></p><p>d. <strong>业务下Namespace列表：</strong> 这里可以管理业务下的Namespace</p><p><img src=../../../../images/%E4%B8%9A%E5%8A%A1Namespace%E5%88%97%E8%A1%A8.png alt=&#x4E1A;&#x52A1;&#x4FE1;&#x606F;></p><p>​ 单击【新建Namespace】。在“新建Namespace”页面中，填写相关信息。如下图所示：</p><p><img src=../../../../images/my-ns.png alt=&#x65B0;&#x5EFA;&#x7A7A;&#x95F4;&#x5217;&#x8868;></p><p>​ <strong>名称</strong>：不能超过63个字符，这里以<code>new-ns</code>为例</p><p>​ <strong>集群</strong>：<code>my-business</code>业务中的集群，这里以<code>global</code>集群为例</p><p>​ <em>资源限制*</em>：这里可以限制当前命名空间下各种资源的使用量，可以不设置。</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-2eac969bd1933c41613cedbe9af4c914>4 - 扩展组件</h1><div class=lead>扩展组件</div><h1 id=扩展组件>扩展组件</h1><h2 id=概念>概念</h2><p><strong>这里用户可以管理集群扩展组件。</strong></p><h2 id=操作步骤>操作步骤</h2><h3 id=创建组件>创建组件</h3><ul><li>登录 TKEStack。</li><li>切换至 【平台管理】控制台，选择【扩展组件】页面。</li><li>选择需要安装组件的集群，点击【新建】按钮。如下图所示：</li></ul><p><img src=../../../../../images/%E6%96%B0%E5%BB%BA%E6%89%A9%E5%B1%95%E7%BB%84%E4%BB%B6.png alt=&#x65B0;&#x5EFA;&#x7EC4;&#x4EF6;></p><blockquote><p>注意：此页面右边的【删除】按钮可以删除安装了的组件</p></blockquote><ul><li>在弹出的扩展组件列表里，选择要安装的组件。如下图所示：</li></ul><p><img src=../../../../../images/%E9%80%89%E6%8B%A9%E6%89%A9%E5%B1%95%E7%BB%84%E4%BB%B6.png alt=&#x9009;&#x62E9;&#x6269;&#x5C55;&#x7EC4;&#x4EF6;></p><blockquote><p>注意：如果选择的是PersistentEvent，需要在下方输入地址和索引。</p></blockquote><ul><li>单击【完成】。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f8882211bf86e03e9ad6a7593f6389f4>4.1 - TApp 介绍</h1><div class=lead>TApp 介绍</div><h2 id=tapp-介绍>TApp 介绍</h2><p>Kubernetes 现有应用类型（如：Deployment、StatefulSet等）无法满足很多非微服务应用的需求。比如：操作（升级、停止等）应用中的指定 Pod；应用支持多版本的 Pod。如果要将这些应用改造为适合于这些 Workload 的应用，需要花费很大精力，这将使大多数用户望而却步。</p><p>为解决上述复杂应用管理场景，TKEStack 基于 Kubernetes <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/>CRD</a> 开发了一种新的应用类型 <a href=https://github.com/tkestack/tapp><strong>TApp</strong></a>，它是一种通用类型的 Workload，同时支持 service 和 batch 类型作业，满足绝大部分应用场景，它能让用户更好的将应用迁移到 Kubernetes 集群。</p><h2 id=tapp-架构>TApp 架构</h2><p>TAPP 其结构定义见 <a href=https://github.com/tkestack/tapp/blob/master/pkg/apis/tappcontroller/v1/types.go#L41>TAPP struct</a>。TApp Controller 是 TApp 对应的Controller/<a href=https://coreos.com/operators/>operator</a>，它通过 kube-apiserver 监听 TApp、Pod 相关的事件，根据 TApp 的 spec 和 status 进行相应的操作：创建、删除pod等。</p><p><img src=../../../../../images/image%20%28105%29.png alt></p><h3 id=tapp-使用场景>TApp 使用场景</h3><p>Kubernetes 凭借其强大的声明式 API、丰富的特性和可扩展性，逐渐成为容器编排领域的霸主。越来越多的用户希望使用 Kubernetes，将现有的应用迁移到 Kubernetes 集群，但 Kubernetes 现有 Workload（如：<code>Deployment</code>、<code>StatefulSet</code>等）无法满足很多非微服务应用的需求，比如：操作（升级、停止等）应用中的指定 Pod、应用支持多版本的 Pod。如果要将这些应用改造为适合于这些 Workload的应用，需要花费很大精力，这将使大多数用户望而却步。</p><p>腾讯有着多年的容器编排经验，基于 Kuberentes CRD（Custom Resource Definition，使用声明式API方式，无侵入性，使用简单）开发了一种新的 Workload 类型 TApp，它是一种通用类型的 Workload，同时支持 service 和 batch 类型作业，满足绝大部分应用场景，它能让用户更好的将应用迁移到 Kubernetes 集群。如果用 Kubernetes 的 Workload 类比，TAPP ≈ Deployment + StatefulSet + Job ，它包含了 Deployment、StatefulSet、Job 的绝大部分功能，同时也有自己的特性，并且和原生 Kubernetes 相同的使用方式完全一致。经过这几年用户反馈， TApp 也得到了逐渐的完善。</p><h3 id=tapp-特点>TApp 特点</h3><ol><li><strong>同时支持 service 和 batch 类型作业</strong>。通过 RestartPolicy 来对这两种作业进行区分。RestartPolicy值有三种：RestartAlways、Never、OnFailure<ol><li><strong>RestartAlways</strong>：表示 Pod 会一直运行，如果结束了也会被重新拉起（适合 service 类型作业）</li><li><strong>Never</strong>：表示 Pod 结束后就不会被拉起了（适合 batch 类型作业）</li><li><strong>OnFailure</strong>：表示 Pod 结束后，如果 exit code 非0，将会被拉起，否则不会（适合 batch 类型作业）</li></ol></li><li><strong>固定ID</strong>：每个实例（Pod）都有固定的 ID(0, 1, 2 … N-1，其中N为实例个数)，它们的名字由 <strong>TApp 名字+ID</strong> 组成，因此名字也是唯一的。 有了固定的ID和名字后，我们便可以实现如下能力：<ol><li>将实例用到的各种资源（将实例用到的存储资源(如：云硬盘)，或者是IP）和实例一一对应起来，这样即使实例发生迁移，实例对应的各种资源也不会变</li><li>通过固定 ID，我们可以为实例分配固定的 IP（float ip）。</li><li>唯一的实例名字还可用来跟踪实例完整的生命周期，对于同一个实例，可以由于机器故障发生了迁移、重启等操作，虽然不是一个 Pod 了，但是我们用实例 ID 串联起来，就获得了实例真正的生命周期的跟踪，对于判断业务和系统是否正常服务具有特别重要的意义</li></ol></li><li><strong>操作指定实例</strong>：有了固定的 ID，我们就能操作指定实例。我们遵循了 Kubernetes 声明式的 API，在 spec 中 statuses 记录实例的目标状态， instances 记录实例要使用的 template，用于停止、启动、升级指定实例。</li><li><strong>支持多版本实例</strong>：在 TApp spec 中，不同的实例可以指定不同的配置（image、resource 等）、不同的启动命令等，这样一个应用可以存在多个版本实例。</li><li><strong>原地更新(in place update)</strong>：Kubernetes 的更新策略是删除旧 Pod，新建一个 Pod，然后调度等一系列流程，才能运行起来，而且 Pod原先的绑定的资源（本地磁盘、IP 等）都会变化。TApp 对此进行了优化：如果只修改了 container 的 image，TApp 将会对该 Pod 进行本地更新，原地重启受影响的容器，本地磁盘不变，IP 不变，最大限度地降低更新带来的影响，这能极大地减少更新带来的性能损失以及服务不可用。</li><li><strong>云硬盘</strong>：云硬盘的底层由分布式存储 Ceph 支持，能很好地支持有状态的作业。在实例发生跨机迁移时，云硬盘能跟随实例一起迁移。TApp 提供了多种云硬盘类型供选择。</li><li><strong>多种升级发布方式</strong>：TApp除了支持常规的蓝绿布署、滚动发布、金丝雀部署等升级发布方式，还有其特有的升级发布方式：用户可以指定升级任意的实例。</li><li><strong>自动扩缩容</strong>：根据 CPU/MEM/用户自定义指标对 TAPP 进行自动扩缩容。 除了自动扩缩容，我们还开发了周期性扩缩容 <a href=https://github.com/tkestack/tke/blob/master/hack/addon/readme/CronHPA.md>CronHPA</a> 支持对 TApp 等(包括 Kubernetes 原生的 Deployment 和 StatefulSet)进行周期性扩缩容，支持 CronTab 语法格式，满足对资源使用有周期性需求的业务。</li><li><strong>Gang scheduling</strong>：有些应用必须要等到获取到资源能运行的实例达到一定数量后才开始运行，TApp 提供的 <a href=https://en.wikipedia.org/wiki/Gang_scheduling>Gang scheduling</a> 正是处理这种情况的。</li></ol><p><img src=../../../../../images/image%20%2871%29.png alt></p><h3 id=部署在集群内-kubernetes-对象>部署在集群内 kubernetes 对象</h3><p>在集群内部署 TApp Add-on , 将在集群内部署以下 kubernetes 对象</p><table><thead><tr><th style=text-align:left>kubernetes 对象名称</th><th style=text-align:left>类型</th><th style=text-align:left>默认占用资源</th><th style=text-align:left>所属Namespaces</th></tr></thead><tbody><tr><td style=text-align:left>tapp-controller</td><td style=text-align:left>Deployment</td><td style=text-align:left>每节点1核CPU, 512MB内存</td><td style=text-align:left>kube-system</td></tr><tr><td style=text-align:left>tapps.apps.tkestack.io</td><td style=text-align:left>CustomResourceDefinition</td><td style=text-align:left>/</td><td style=text-align:left>/</td></tr><tr><td style=text-align:left>tapp-controller</td><td style=text-align:left>ServiceAccount</td><td style=text-align:left>/</td><td style=text-align:left>kube-system</td></tr><tr><td style=text-align:left>tapp-controller</td><td style=text-align:left>Service</td><td style=text-align:left>/</td><td style=text-align:left>kube-system</td></tr><tr><td style=text-align:left>tapp-controller</td><td style=text-align:left>ClusterRoleBinding（ClusterRole/cluster-admin）</td><td style=text-align:left>/</td><td style=text-align:left>/</td></tr></tbody></table><h2 id=tapp-使用方法>TApp 使用方法</h2><h3 id=安装-tapp-组件>安装 TApp 组件</h3><ul><li>登录 TKEStack</li><li>切换至 平台管理 控制台，选择扩展组件页面</li><li>选择需要安装组件的集群，点击【新建】按钮。如下图所示：</li></ul><p><img src=../../../../../images/image%20%2849%29.png alt></p><ul><li>在弹出的扩展组件列表里，滑动列表窗口找到tapp组件。如下图所示：</li></ul><p><img src=../../../../../images/image%20%2820%29.png alt></p><ul><li><p>单击【完成】</p><p>安装完成后会在刚刚安装了 TApp 扩展组件的集群里 【工作负载】下面出现【TApp】，如下图所示：</p></li></ul><p><img src=../../../../../images/image%20%2890%29.png alt></p><h3 id=使用-tapp-组件>使用 TApp 组件</h3><p>在 TKEStack 控制台上使用 TApp 使用请参考：<a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/products/business-control-pannel/application/workload/tapp.md>TApp Workload</a></p><p>对 TApp 架构和命令行使用请参考：<a href=https://github.com/tkestack/tapp/blob/master/doc/tutorial.md>TApp Repository</a></p><h2 id=参考>参考</h2><h3 id=手动部署-tapp>手动部署 TApp</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>git clone https://github.com/tkestack/tapp.git
cd tapp
make build
bin/tapp-controller --kubeconfig=$HOME/.kube/config
</code></pre></div><h3 id=原地升级>原地升级</h3><p>修改 <code>spec.templatePool.{templateName}.spec.containers.image</code> 的值实现原地升级。</p><p>挂在存储卷后的 Pod 依旧在 image 升级的时候没有任何影响，同时 PVC 也没有改变，唯一改变的只有镜像本身。</p><h3 id=部分关键字解释>部分关键字解释</h3><table><thead><tr><th style=text-align:left>关键字</th><th style=text-align:left>作用</th></tr></thead><tbody><tr><td style=text-align:left>spec.templatePool</td><td style=text-align:left>模版池</td></tr><tr><td style=text-align:left>spec.templates</td><td style=text-align:left>以键值对（Pod 序号：模板池中的模板名）的形式具体声明每一个 Pod 的状态</td></tr><tr><td style=text-align:left>spec.template 等价于 spec.DefaultTemplateName</td><td style=text-align:left>默认模板（在spec.templates中没有定义的 Pod 序号将使用该模板）</td></tr><tr><td style=text-align:left>updateStrategy.inPlaceUpdateStrategy</td><td style=text-align:left>原地升级策略</td></tr><tr><td style=text-align:left>spec.updateStrategy</td><td style=text-align:left>保留旧版本 Pod 的数量，默认为 0，类似于灰度发布</td></tr><tr><td style=text-align:left>spec.updateStrategy.template</td><td style=text-align:left>要设置 maxUnavailable 值的 template 名</td></tr><tr><td style=text-align:left>spec.updateStrategy.maxUnavailable</td><td style=text-align:left>最大的不可用 Pod 数量（默认为1，可设置成一个自然数，或者一个百分比，例如 50%）</td></tr><tr><td style=text-align:left>spec.statuses</td><td style=text-align:left>明确 Pod 的状态，TApp 会实现该状态</td></tr></tbody></table><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>apiVersion: apps.tkestack.io/v1
kind: TApp
metadata:
  name: example-tapp
spec:
  replicas: 3
  # 默认模板
  template:
    metadata:
      labels:
        app: example-tapp
    spec:
      containers:
      - name: nginx
        image: nginx:latest
  # 模板池
  templatePool:
  	# 模板池中的模板
    &#34;test2&#34;:
      metadata:
        labels:
          app: example-tapp
      spec:
        containers:
        - name: nginx
          image: nginx:1.7.9
  # 要使用模板池中模板的 Pod
  templates:
    # Pod 序号：模板池中的模板
    &#34;1&#34;: &#34;test2&#34;
    &#34;2&#34;: &#34;test2&#34;
  # 更新策略
  updateStrategy:
    # 更新指定模板。test2该模板有过修改，或者是在模板池里新增的，都可以通过 updateStrategy 设置模板来进行滚动更新
    template: test2
    # 使用该模板的 Pod 在更新时最大不可用的数量
    maxUnavailable: 1
  # 明确 Pod 的状态，TApp 会实现该状态
  statuses:
    # 编号为1的 Pod 将被 Kill
    &#34;1&#34;: &#34;Killed&#34;
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-36486ddbc5cae072d21407bccf243040>4.2 - CronHPA 介绍</h1><div class=lead>CronHPA 介绍</div><h2 id=cronhpa-介绍>CronHPA 介绍</h2><p>Cron Horizontal Pod Autoscaler(<a href=https://github.com/tkestack/cron-hpa>CronHPA</a>) 可让用户利用 <a href=https://en.wikipedia.org/wiki/Cron>CronTab</a> 实现对负载（Deployment、StatefulSet、<a href=https://github.com/tkestack/tke/blob/master/hack/addon/readme/TappController.md>TApp</a> 这些支持扩缩容的资源对象）<strong>定期自动扩缩容</strong>。</p><p><a href=https://en.wikipedia.org/wiki/Cron>CronTab</a> 格式说明如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># 文件格式说明
#  ——分钟（0 - 59）
# |  ——小时（0 - 23）
# | |  ——日（1 - 31）
# | | |  ——月（1 - 12）
# | | | |  ——星期（0 - 6）
# | | | | |
# * * * * *
</code></pre></div><p>CronHPA 定义了一个新的 CRD，cron-hpa-controller 是该 CRD 对应的 Controller/operator，它解析 CRD 中的配置，根据系统时间信息对相应的工作负载进行扩缩容操作。</p><h3 id=cronhpa-使用场景>CronHPA 使用场景</h3><p>以游戏服务为例，从星期五晚上到星期日晚上，游戏玩家数量暴增。如果可以将游戏服务器在星期五晚上扩大规模，并在星期日晚上缩放为原始规模，则可以为玩家提供更好的体验。这就是游戏服务器管理员每周要做的事情。</p><p>其他一些服务也会存在类似的情况，这些产品使用情况会定期出现高峰和低谷。CronHPA 可以自动化实现提前扩缩 Pod，为用户提供更好的体验。</p><h3 id=部署在集群内-kubernetes-对象>部署在集群内 kubernetes 对象</h3><p>在集群内部署 CronHPA Add-on , 将在集群内部署以下 kubernetes 对象：</p><table><thead><tr><th style=text-align:left>kubernetes 对象名称</th><th style=text-align:left>类型</th><th style=text-align:left>默认占用资源</th><th style=text-align:left>所属 Namespaces</th></tr></thead><tbody><tr><td style=text-align:left>cron-hpa-controller</td><td style=text-align:left>Deployment</td><td style=text-align:left>每节点1核 CPU, 512MB内存</td><td style=text-align:left>kube-system</td></tr><tr><td style=text-align:left>cronhpas.extensions.tkestack.io</td><td style=text-align:left>CustomResourceDefinition</td><td style=text-align:left>/</td><td style=text-align:left>/</td></tr><tr><td style=text-align:left>cron-hpa-controller</td><td style=text-align:left>ClusterRoleBinding（ClusterRole/cluster-admin）</td><td style=text-align:left>/</td><td style=text-align:left>/</td></tr><tr><td style=text-align:left>cron-hpa-controller</td><td style=text-align:left>ServiceAccount</td><td style=text-align:left>/</td><td style=text-align:left>kube-system</td></tr></tbody></table><h2 id=cronhpa-使用方法>CronHPA 使用方法</h2><h3 id=安装-cronhpa>安装 CronHPA</h3><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【扩展组件】页面</li><li>选择需要安装组件的集群，点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28128%29.png alt></p><ul><li>在弹出的扩展组件列表里，滑动列表窗口找到 CronHPA 组件</li><li>单击【完成】</li></ul><h3 id=在控制台上使用-cronhpa>在控制台上使用 CronHPA</h3><p>TKEStack 已经支持在页面多处位置为负载配置 CronHPA</p><ul><li>新建负载页（负载包括Deployment、StatefulSet、TApp）这里新建负载时将会同时新建与负载同名的 CronHPA 对象：</li></ul><p><img src=../../../../../images/image%20%2897%29.png alt></p><p>每条触发策略由两条字段组成</p><ol><li><strong>Crontab</strong> ：例如 &ldquo;0 23 * * 5"表示每周五23:00，详见<a href=https://en.wikipedia.org/wiki/Cron>crontab</a></li><li><strong>目标实例数</strong> ：设置实例数量</li></ol><ul><li>自动伸缩的 CronHPA 列表页。此处可以查看/修改/新建 CronHPA：</li></ul><p><img src=../../../../../images/image%20%2815%29.png alt></p><h3 id=通过-yaml-使用-cronhpa>通过 YAML 使用 CronHPA</h3><h4 id=创建-cronhpa-对象>创建 CronHPA 对象</h4><p>示例1：指定 Deployment 每周五20点扩容到60个实例，周日23点缩容到30个实例</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>apiVersion: extensions.tkestack.io/v1
kind: CronHPA
metadata:
  name: example-cron-hpa	# CronHPA 名
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment	# CronHPA 操作的负载类型
    name: demo-deployment	# CronHPA 操作的负载类型名
  crons:
    - schedule: &#34;0 20 * * 5&#34;	# Crontab 语法格式
      targetReplicas: 60			# 负载副本（Pod）的目标数量
    - schedule: &#34;0 23 * * 7&#34;
      targetReplicas: 30
</code></pre></div><p>示例2：指定 Deployment 每天8点到9点，19点到21点扩容到60，其他时间点恢复到10</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>apiVersion: extensions.tkestack.io/v1
kind: CronHPA
metadata:
  name: web-servers-cronhpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: web-servers
  crons:
    - schedule: &#34;0 8 * * *&#34;
      targetReplicas: 60
    - schedule: &#34;0 9 * * *&#34;
      targetReplicas: 10
    - schedule: &#34;0 19 * * *&#34;
      targetReplicas: 60
    - schedule: &#34;0 21 * * *&#34;
      targetReplicas: 10
</code></pre></div><h4 id=查看已有-cronhpa>查看已有 CronHPA</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># kubectl get cronhpa
NAME               AGE
example-cron-hpa   104s

# kubectl get cronhpa example-cron-hpa -o yaml
apiVersion: extensions.tkestack.io/v1
kind: CronHPA
...
spec:
  crons:
  - schedule: 0 20 * * 5
    targetReplicas: 60
  - schedule: 0 23 * * 7
    targetReplicas: 30
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: demo-deployment
</code></pre></div><h4 id=删除已有-cronhpa>删除已有 CronHPA</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>kubectl delete cronhpa example-cron-hpa
</code></pre></div><p>CronHPA 项目请参考 <a href=https://github.com/tkestack/cron-hpa>CronHPA Repository</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-10c69052f011daaf2098d301331d233d>4.3 - 监控组件</h1><div class=lead>监控组件</div><h2 id=prometheus>Prometheus</h2><p>良好的监控环境为 TKEStack 高可靠性、高可用性和高性能提供重要保证。您可以方便为不同资源收集不同维度的监控数据，能方便掌握资源的使用状况，轻松定位故障。</p><p>TKEStack 使用开源的 Prometheus 作为监控组件，免去您部署和配置 Prometheus 的复杂操作，TKEStack 提供高可用性和可扩展性的细粒度监控系统，实时监控 CPU，GPU，内存，显存，网络带宽，磁盘 IO 等多种指标并自动绘制趋势曲线，帮助运维人员全维度的掌握平台运行状态。</p><p>TKEStack 使用 Prometheus 的架构和原理可以参考 <a href=https://github.com/tkestack/tke/blob/master/hack/addon/readme/Prometheus.md>Prometheus 组件</a></p><blockquote><p>指标具体含义可参考：<a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/FAQ/Platform/alert&monitor-metrics.md>监控 & 告警指标列表</a></p></blockquote><p><img src=../../../../../images/image%20%2873%29.png alt></p><p>TKEStack 通过 Prometheus 组件监控集群状态，Prometheus 组件通过 addon 扩展组件自动完成安装和配置，使用 InfluxDB，ElasticSearch 等存储监控数据。监控数据和指标融入到平台界面中以风格统一图表的风格展示，支持以不同时间，粒度等条件，查询集群，节点，业务，Workload 以及容器等多个层级的监控数据，全维度的掌握平台运行状态。</p><p>同时针对在可用性和可扩展性方面，支持使用 Thanos 架构提供可靠的细粒度监控和警报服务，构建具有高可用性和可扩展性的细粒度监控能力。</p><h3 id=安装-prometheus>安装 Prometheus</h3><p>Prometheus 为 TKEStack 扩展组件，需要在集群的 <a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/products/platform/cluster.md#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF>【基本信息】</a> 页下面开启 “监控告警”。</p><p><img src=../../../../../images/image%20%2836%29.png alt></p><h3 id=集群监控>集群监控</h3><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【集群管理】</li><li>点击【监控】图标，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28141%29.png alt></p><ul><li>监控数据展示</li><li>通过下图中的1可以选择监控数据时间段</li><li>通过下图中的2可以选择统计粒度，以下图中“APIServer时延”为例，下图中的每个数据表示前1分钟“APIServer时延”平均数</li></ul><p><img src=../../../../../images/image%20%2824%29.png alt></p><ul><li>上下滑动曲线图可以获得更多监控指标</li><li>点击曲线图，会弹出具体时间点的具体监控数据</li></ul><p><img src=../../../../../images/image%20%2863%29.png alt></p><blockquote><p>指标具体含义可参考：<a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/FAQ/Platform/alert&monitor-metrics.md>监控 & 告警指标列表</a></p></blockquote><h3 id=节点监控>节点监控</h3><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【集群管理】</li><li>点击【集群 ID】 -> 【节点管理】->【节点】->【监控】图标，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2839%29.png alt></p><ul><li><p>具体查看方式和<a href>集群监控</a>完全一致</p><blockquote><p>指标具体含义可参考：<a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/FAQ/Platform/alert&monitor-metrics.md>监控 & 告警指标列表</a></p></blockquote></li><li><p>此处还可以查看节点下的 Pod 监控</p><ol><li>如下图所示，对比维度可选择 节点 或 Pod</li><li>选择 Pod ，需要在其右侧选择 Pod 所属节点</li></ol></li></ul><p><img src=../../../../../images/image%20%28139%29.png alt></p><h4 id=节点下的-pod--container-监控>节点下的 Pod & Container 监控</h4><p>有两种方式</p><ul><li><a href>节点监控</a> 下选择 Pod 进行监控</li><li>在节点列表里，点击节点名，进入节点的 Pod 管理页，如下图所示，点击上方的【监控】按钮，实现对节点下的 Pod 监控</li></ul><p><img src=../../../../../images/image%20%286%29.png alt></p><blockquote><p>注意：此处还可以查看节点下的 Container 监控</p><ol><li>如下图所示，对比维度可选择 Pod 或 Container</li><li>选择 Container ，需要在其右侧选择 Container 所属 Pod</li></ol></blockquote><p><img src=../../../../../images/image%20%2850%29.png alt></p><p>指标具体含义可参考：<a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/FAQ/Platform/alert&monitor-metrics.md>监控 & 告警指标列表</a></p><h3 id=负载监控>负载监控</h3><ul><li><p>登录 TKEStack</p></li><li><p>切换至【平台管理】控制台，选择【集群管理】</p></li><li><p>点击【集群 ID】 -> 【工作负载】->【选择一种负载，例如 Deployment】->【监控】图标，如下图所示：</p></li><li><p>具体查看方式和<a href>集群监控</a>完全一致</p><blockquote><p>指标具体含义可参考：<a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/FAQ/Platform/alert&monitor-metrics.md>监控 & 告警指标列表</a></p></blockquote></li></ul><h4 id=负载下-pod--container-监控>负载下 Pod & Container 监控</h4><ol><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【集群管理】</li><li>点击【集群 ID】 -> 【工作负载】->【选择一种负载】，例如 Deployment】->【点击一个负载名】->【监控】图标，如下图所示：</li></ol><p><img src=../../../../../images/image%20%2872%29.png alt></p><blockquote><p>注意：此处还可以查看负载下的 Container 监控</p><ol><li>如下图所示，对比维度可选择 Pod 或 Container</li><li>选择 Container ，需要在其右侧选择 Container 所属 Pod 指标具体含义可参考：<a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/FAQ/Platform/alert&monitor-metrics.md>监控 & 告警指标列表</a></li></ol></blockquote><p><img src=../../../../../images/image%20%28132%29.png alt></p><p>TKEStack 使用 Prometheus 的架构和原理可以参考 <a href=https://github.com/tkestack/tke/blob/master/hack/addon/readme/Prometheus.md>Prometheus 组件</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-6dcd138c670444e4d6bd8c3e521b6e9d>4.4 - LogAgent 介绍</h1><div class=lead>LogAgent 介绍</div><h2 id=日志采集>日志采集</h2><h3 id=logagent-介绍>LogAgent 介绍</h3><p>TKESTack 通过 logagent 提供的集群内日志采集功能，支持将集群内服务或集群节点特定路径文件的日志发送至 Kafka、Elasticsearch 等消费端，支持采集容器标准输出日志，容器内文件日志以及主机内文件日志。更提供事件持久化、审计等功能，实时记录集群事件及操作日志记录，帮助运维人员存储和分析集群内部资源生命周期、资源调度、异常告警等情况。</p><p><img src=../../../../../images/image%20%2823%29.png alt></p><blockquote><p>TKEStack 老版本日志使用 LogCollector 扩展组件。LogAgent 用于替换 LogCollector，新版本统一用 LogAgent 完成日志采集功能。</p></blockquote><p>日志收集功能需要为每个集群手动开启。日志收集功能开启后，日志收集组件 logagent 会在集群内以 Daemonset 的形式运行。用户可以通过日志收集规则配置日志的采集源和消费端，日志收集 Agent 会从用户配置的采集源进行日志收集，并将日志内容发送至用户指定的消费端。需要注意的是，<strong>使用日志收集功能需要您确认 Kubernetes 集群内节点能够访问日志消费端。</strong></p><ul><li><strong>采集容器标准输出日志</strong> ：采集集群内指定<strong>容器的 Stderr 和 Stdout 日志。</strong>，采集到的日志信息将会以 JSON 格式输出到用户指定的消费端，并会自动附加相关的 Kubernetes metadata， 包括容器所属 Pod 的 label 和 annotation 等信息。</li><li><strong>采集容器内文件日志</strong> ：采集集群内指定<strong>容器内文件路径的日志</strong>，用户可以根据自己的需求，灵活的配置所需的容器和路径，采集到的日志信息将会以 JSON 格式输出到用户指定的消费端， 并会附加相关的 Kubernetes metadata，包括容器所属 Pod 的 label 和 annotation 等信息。</li><li><strong>采集主机内文件日志</strong> ：采集集群内所有节点的指定<strong>主机文件路径的日志</strong>，logagent 会采集集群内所有节点上满足指定路径规则的文件日志，以 JSON 格式输出到用户指定的输出端， 并会附加用户指定的 metadata，包括日志来源文件的路径和用户自定义的 metadata。</li></ul><h4 id=部署在集群内-kubernetes-对象>部署在集群内 kubernetes 对象</h4><p>在集群内部署 logagent Add-on , 将在集群内部署以下 kubernetes 对象</p><table><thead><tr><th style=text-align:left>kubernetes 对象名称</th><th style=text-align:left>类型</th><th style=text-align:left>默认占用资源</th><th style=text-align:left>所属Namespaces</th></tr></thead><tbody><tr><td style=text-align:left>logagent</td><td style=text-align:left>DaemonSet</td><td style=text-align:left>每节点0.3核 CPU, 250MB 内存</td><td style=text-align:left>kube-system</td></tr><tr><td style=text-align:left>logagent</td><td style=text-align:left>ServiceAccount</td><td style=text-align:left></td><td style=text-align:left>kube-system</td></tr></tbody></table><h3 id=使用日志采集服务>使用日志采集服务</h3><blockquote><p>注意：日志采集对接外部 Kafka 或 Elasticsearch，该功能需要额外开启，位置在集群 <a href=https://github.com/tkestack/tke/blob/master/hack/platform/cluster.md#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF>基本信息</a> 下面，点击开启“日志采集”服务。</p></blockquote><p><img src=../../../../../images/image%20%2828%29.png alt></p><h4 id=业务管理侧>业务管理侧</h4><ul><li>登录 TKEStack</li><li>切换至【业务管理】控制台，选择 【运维中心】->【日志采集】</li><li>选择相应【业务】和【命名空间】，单击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%287%29.png alt></p><ul><li>在“新建日志采集”页面填写日志采集信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2847%29.png alt></p><ul><li><strong>收集规则名称：</strong> 输入规则名，1～63字符，只能包含小写字母、数字及分隔符("-")，且必须以小写字母开头，数字或小写字母结尾</li><li><strong>业务：</strong> 选择所属业务（业务管理侧才会出现）</li><li><strong>集群：</strong> 选择所属集群（平台管理侧才会出现）</li><li><strong>类型：</strong> 选择采集类型<ul><li><strong>容器标准输出：</strong> 容器 Stderr 和 Stdout 日志信息采集<ul><li><strong>日志源：</strong> 可以选择所有容器或者某个 Namespace 下的所有容器/工作负载<ul><li><strong>所有容器：</strong> 所有容器</li><li><strong>指定容器：</strong> 某个 Namespace 下的所有容器或者工作负载</li></ul></li></ul></li><li><strong>容器文件路径：</strong> 容器内文件内容采集<ul><li><p><strong>日志源：</strong> 可以采集具体容器内的某个文件路径下的文件内容</p><ul><li><strong>工作负载选项：</strong> 选择某个 Namespace 下的某种工作负载类型下的某个工作负载</li><li><strong>配置采集路径：</strong> 选择某个容器下的某个文件路径</li></ul><blockquote><ul><li>文件路径若输入<code>stdout</code>，则转为容器标准输出模式</li><li>可配置多个路径。路径必须以<code>/</code>开头和结尾，文件名支持通配符（*）。文件路径和文件名最长支持63个字符</li><li>请保证容器的日志文件保存在数据卷，否则收集规则无法生效，详见<a href>指定容器运行后的日志目录</a></li></ul></blockquote></li></ul></li><li><strong>节点文件路径：</strong> 收集节点上某个路径下的文件内容，不会重复采集，因为采集器会记住之前采集过的日志文件的位点，只采集增量部分<ul><li><strong>日志源：</strong> 可以采集具体节点内的某个文件路径下的文件内容<ul><li><strong>收集路径：</strong> 节点上日志收集路径。路径必须以<code>/</code>开头和结尾，文件名支持通配符（*）。文件路径和文件名最长支持63个字符</li><li><strong>metadata：</strong> key：value 格式，收集的日志会带上 metadata 信息上报给消费端</li></ul></li></ul></li></ul></li><li><strong>消费端：</strong> 选择日志消费端<ul><li><strong>Kafka：</strong><ul><li><strong>访问地址：</strong> Kafka IP 和端口</li><li><strong>主题（Topic）：</strong> Kafka Topic 名</li></ul></li><li><strong>Elasticsearch：</strong><ul><li><p><strong>Elasticsearch 地址：</strong> ES 地址，如：<a href=http://190.0.0.1:200/>http://190.0.0.1:200</a></p><blockquote><p>注意：当前只支持未开启用户登录认证的 ES 集群</p></blockquote></li><li><p><strong>索引：</strong> ES索引，最长60个字符，只能包含小写字母、数字及分隔符("-"、"_"、"+")，且必须以小写字母开头</p></li></ul></li></ul></li><li>单击【完成】按钮</li></ul><h4 id=平台管理侧>平台管理侧</h4><p>在平台管理侧也支持日志采集规则的创建，创建方式和业务管理处相同。详情可点击平台侧的<a href=https://github.com/tkestack/tke/blob/master/hack/platform/operation/log.md>日志采集</a>。</p><h4 id=指定容器运行后的日志目录>指定容器运行后的日志目录</h4><p>LogAgent 除了支持日志规则的创建，也支持指定容器运行后的日志目录，可实现日志文件展示和下载。</p><blockquote><p>前提：需要在创建负载时挂载数据卷，并指定日志目录</p></blockquote><p><img src=../../../../../images/image%20%28134%29.png alt></p><p>创建负载以后，在容器内的<code>/data/logdir</code>目录下的所有文件可以展示并下载，例如我们在容器的<code>/data/logdir</code>下新建一个名为<code>a.log</code>的文件，如果有内容的话，也可以在这里展示与下载：</p><p><img src=../../../../../images/image%20%2832%29.png alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-901ced327a8b1d8464a48213006e87cc>4.5 - GPUManager 介绍</h1><div class=lead>GPUManager 介绍</div><h2 id=gpumanager-介绍>GPUManager 介绍</h2><p><a href=https://github.com/tkestack/gpu-manager>GPUManager</a> 提供一个 All-in-One 的 GPU 管理器, 基于 Kubernets Device Plugin 插件系统实现，该管理器提供了分配并共享 GPU，GPU 指标查询，容器运行前的 GPU 相关设备准备等功能，支持用户在 Kubernetes 集群中使用 GPU 设备。</p><p>GPU-Manager 包含如下功能:</p><ul><li><strong>拓扑分配</strong>：提供基于 GPU 拓扑分配功能，当用户分配超过1张 GPU 卡的应用，可以选择拓扑连接最快的方式分配GPU设备</li><li><strong>GPU 共享</strong>：允许用户提交小于1张卡资源的的任务，并提供 QoS 保证</li><li><a href><strong>应用 GPU 指标的查询</strong></a>：用户可以访问主机的端口(默认为5678)的<code>/metrics</code> 路径，可以为 Prometheus 提供 GPU 指标的收集功能，<code>/usage</code> 路径可以提供可读性的容器状况查询</li></ul><h3 id=gpu-manager-使用场景>GPU-Manager 使用场景</h3><p>在 Kubernetes 集群中运行 GPU 应用时，可以解决 AI 训练等场景中申请独立卡造成资源浪费的情况，让计算资源得到充分利用。</p><h3 id=gpu-manager-限制条件>GPU-Manager 限制条件</h3><ol><li><p>该组件基于 Kubernetes DevicePlugin 实现，只能运行在支持 DevicePlugin 的 kubernetes版本（Kubernetes 1.10 之上的版本）</p></li><li><p>使用 GPU-Manager 要求集群内包含 GPU 机型节点</p></li><li><p>TKEStack 的 GPU-Manager 将每张 GPU 卡视为一个有100个单位的资源</p><blockquote><p>特别注意：</p><ol><li>当前仅支持 0-1 的小数张卡，如 20、35、50；以及正整数张卡，如200、500等；不支持类似150、250的资源请求</li><li>显存资源是以 256MiB 为最小的一个单位的分配显存</li></ol></blockquote></li></ol><h3 id=部署在集群内-kubernetes-对象>部署在集群内 kubernetes 对象</h3><p>在集群内部署 GPU-Manager，将在集群内部署以下 kubernetes 对象：</p><table><thead><tr><th style=text-align:left>kubernetes 对象名称</th><th style=text-align:left>类型</th><th style=text-align:left>建议预留资源</th><th style=text-align:left>所属 Namespaces</th></tr></thead><tbody><tr><td style=text-align:left>gpu-manager-daemonset</td><td style=text-align:left>DaemonSet</td><td style=text-align:left>每节点1核 CPU, 1Gi内存</td><td style=text-align:left>kube-system</td></tr><tr><td style=text-align:left>gpu-quota-admission</td><td style=text-align:left>Deployment</td><td style=text-align:left>1核 CPU, 1Gi内存</td><td style=text-align:left>kube-system</td></tr></tbody></table><h2 id=gpu-manager-使用方法>GPU-Manager 使用方法</h2><h3 id=安装-gpu-manager>安装 GPU-Manager</h3><p>集群部署阶段选择 vGPU，平台会为集群部署 GPU-Manager ，如下图新建独立集群所示，Global 集群的也是如此安装。</p><p><img src=../../../../../images/image%20%28117%29.png alt></p><h3 id=在节点安装-gpu-驱动>在节点安装 GPU 驱动</h3><p>集群部署阶段添加 GPU 节点时有勾选 GPU 选项，平台会自动为节点安装 GPU 驱动，如下图所示：</p><blockquote><p>注意：如果集群部署阶段节点没有勾选 GPU，需要自行在有 GPU 的节点上安装 GPU 驱动</p></blockquote><p><img src=../../../../../images/image%20%2877%29.png alt></p><h3 id=工作负载使用-gpu>工作负载使用 GPU</h3><h4 id=通过控制台使用>通过控制台使用</h4><p>在安装了 GPU-Manager 的集群中，创建工作负载时可以设置 GPU 限制，如下图所示：</p><blockquote><p>注意：</p><ol><li>卡数只能填写 0.1 到 1 之间的两位小数或者是所有自然数，例如：0、0.3、0.56、0.7、0.9、1、6、34，不支持 1.5、2.7、3.54</li><li>显存只能填写自然数 n，负载使用的显存为 n*256MiB</li></ol></blockquote><p><img src=../../../../../images/image%20%28109%29.png alt></p><h4 id=通过-yaml-使用>通过 YAML 使用</h4><p>如果使用 YAML 创建使用 GPU 的工作负载，提交的时候需要在 YAML 为容器设置 GPU 的使用资源。</p><ul><li>CPU 资源需要在 resource 上填写<code>tencent.com/vcuda-core</code></li><li>显存资源需要在 resource 上填写<code>tencent.com/vcuda-memory</code></li></ul><p>例1：使用1张卡的 Pod</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>apiVersion: v1

kind: Pod

...

spec:

  containers:

    - name: gpu

      resources:
        limits: 
          tencent.com/vcuda-core: 100
        requests:
          tencent.com/vcuda-core: 100
</code></pre></div><p>例2，使用 0.3 张卡、5GiB 显存的应用（5GiB = 20*256MB）</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>apiVersion: v1

kind: Pod

...

spec:

  containers:

  - name: gpu

    resources:
      limits:
        tencent.com/vcuda-core: 30
        tencent.com/vcuda-memory: 20
      requests:
        tencent.com/vcuda-core: 30
        tencent.com/vcuda-memory: 20
</code></pre></div><h2 id=gpu-监控数据查询>GPU 监控数据查询</h2><h3 id=通过控制台查询>通过控制台查询</h3><blockquote><p>前提：在集群的<a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/products/platform/cluster.md#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF>【基本信息】</a>页里打开“监控告警”</p></blockquote><p>可以通过集群多个页面的监控按钮里查看到 GPU 的相关监控数据，下图以 集群管理 页对集群的监控为例：</p><p><img src=../../../../../images/image%20%2884%29.png alt></p><h3 id=通过后台手动查询>通过后台手动查询</h3><p>手动获取 GPU 监控数据方式（需要先安装 <a href=http://www.dest-unreach.org/socat/>socat</a>）：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>kubectl port-forward svc/gpu-manager-metric -n kube-system 5678:5678 &amp;
curl http://127.0.0.1:5678/metric
</code></pre></div><p>结果示例：</p><p><img src=../../../../../images/image%20%2848%29.png alt></p><p>GPUManager 项目请参考：<a href=https://github.com/tkestack/gpu-manager>GPUManager Repository</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-1908a7f2ad115ef0bc6b1cde68a4cc21>4.6 - CSIOperator 介绍</h1><div class=lead>CSIOperator 介绍</div><h2 id=csioperator>CSIOperator</h2><h3 id=csioperator-介绍>CSIOperator 介绍</h3><p>Container Storage Interface Operator(CSIOperator)用于部署和更新 Kubernetes 集群中的 CSI 驱动和外部存储组件。</p><h4 id=csioperator-使用场景>CSIOperator 使用场景</h4><p>CSIOperator 用于支持集群方便的使用存储资源，当前支持的存储插件包括 RBD、CephFS、TencentCBS 和 TencentCFS（TencentCFS 正在测试中）</p><ul><li>其中 RBD 和 CephFS 主要用于部署在 IDC 环境的集群</li><li>TencentCBS 和 TencentCFS 用于部署在腾讯云环境的集群</li></ul><h4 id=部署在集群内-kubernetes-对象>部署在集群内 kubernetes 对象</h4><p>在集群内部署 CSIOperator，将在集群内部署以下 kubernetes 对象</p><table><thead><tr><th style=text-align:left>kubernetes 对象名称</th><th style=text-align:left>类型</th><th style=text-align:left>默认占用资源</th><th style=text-align:left>所属 Namespaces</th></tr></thead><tbody><tr><td style=text-align:left>csi-operator</td><td style=text-align:left>Deployment</td><td style=text-align:left>每节点0.2核 CPU, 256MB内存</td><td style=text-align:left>kube-system</td></tr></tbody></table><h3 id=csioperator-使用方法>CSIOperator 使用方法</h3><h4 id=安装-csioperator>安装 CSIOperator</h4><ul><li>登录 TKEStack</li><li>切换至 【平台管理】控制台，选择 【扩展组件】 页面</li><li>选择需要安装组件的集群，点击【新建】按钮。如下图所示：</li></ul><p><img src=../../../../../images/image%20%2860%29.png alt></p><ul><li>在弹出的扩展组件列表里，滑动列表窗口找到 CSIOperator</li><li>单击【完成】进行安装</li></ul><h4 id=通过-csioperator-使用腾讯云存储资源>通过 CSIOperator 使用腾讯云存储资源</h4><ul><li>登录 TKEStack</li><li>切换至 【平台管理】控制台，选择 【集群管理】 页面，如下图1所示：</li><li>点击安装了 CSIOperator 组件的【集群ID】，进入要管理的集群，如下图2所示：</li><li>点击【YAML创建资源】，如下图3所示：</li></ul><p><img src=../../../../../images/image%20%28127%29.png alt></p><ul><li><p>文件中指定各自存储插件镜像的名称，这里以<code>tencentcbs</code>的 YAML 为例：（前提：需要拥有腾讯云账号）</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>apiVersion: storage.tkestack.io/v1
kind: CSI
metadata:
  name: tencentcbsv1
  namespace: kube-system
spec:
  driverName: com.tencent.cloud.csi.cbs
  version: &#34;v1&#34;
  parameters:
    secretID: &#34;xxxxxx&#34;
    secretKey: &#34;xxxxxx&#34;
</code></pre></div><ul><li>secretID、secretKey 来源于 腾讯云控制台 -> 账号中心 -> 访问管理 -> 访问秘钥 -> API密钥管理</li></ul></li><li><p>创建完 CSIOperator 的 CRD 对象，同时会为每个存储插件创建默认的 StorageClass 对象（tencentcbs 的 StorageClass 对象名为 cbs-basic-prepaid），如下图：</p></li></ul><p><img src=../../../../../images/image%20%28140%29.png alt></p><p>其 YAML 如下：</p><p><img src=../../../../../images/image%20%28123%29.png alt></p><ul><li><p>tencentcbs 的 provisioner 名称指定为：<code>com.tencent.cloud.csi.cbs</code></p></li><li><p>tencentcfs 的 provisioner 名称指定为：<code>com.tencent.cloud.csi.cfs</code>，tencentcfs 仍在测试中，目前仅支持 tencentcbs</p></li><li><p>对于磁盘类型（在 StorageClass 的 <code>diskType</code> 中指定）和大小的限制：</p><ul><li>普通云硬（ <code>CLOUD_BASIC</code> ）盘提供最小 100 GB 到最大 16000 GB 的规格选择，支持 40-100MB/s 的 IO 吞吐性能和 数百-1000 的随机 IOPS 性能</li><li>高性能云硬盘（<code>CLOUD_PREMIUM</code>）提供最小 50 GB 到最大 16000 GB 的规格选择</li><li>SSD 云硬盘（<code>CLOUD_SSD</code>）提供最小 100 GB 到最大 16000 GB 的规格选择，单块 SSD 云硬盘最高可提供 24000 随机读写IOPS、260MB/s吞吐量的存储性能</li></ul></li><li><p>默认创建的磁盘类型为普通云硬盘，如果用户希望使用该 StorageClass，可以直接创建使用了该 StorageClass 的 PVC 对象：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-tencentcbs
  namespace: kube-system
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: cbs-basic-prepaid
  resources:
    requests:
      storage: 10Gi
</code></pre></div></li></ul><p>详情请见 <a href=https://github.com/tkestack/csi-operator/blob/master/examples>CSIOperator Example</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-d5c510eb12ae466242386f0cebdb156b>5 - 组织资源</h1><div class=lead>组织资源</div><h1 id=组织资源>组织资源</h1><h2 id=概念>概念</h2><p><strong>这里用户可以管理镜像仓库和凭据。</strong></p></div><div class=td-content><h1 id=pg-64d4646ef1291f0db93a3686d23ec15f>5.1 - 镜像仓库管理</h1><div class=lead>镜像仓库管理</div><h2 id=镜像仓库管理>镜像仓库管理</h2><h3 id=镜像仓库概述>镜像仓库概述</h3><p><strong>镜像仓库</strong>：用于存放 Docker 镜像，Docker 镜像可用于部署容器服务，每个镜像有特定的唯一标识（镜像的 Registry 地址+镜像名称+镜像 Tag）</p><p><strong>镜像类型</strong>：目前镜像支持 Docker Hub 官方镜像和用户私有镜像</p><p><strong>镜像生命周期</strong>：主要包含镜像版本的生成、上传和删除</p><h3 id=新建命名空间>新建命名空间</h3><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【组织资源】->【镜像仓库管理】</li><li>点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2888%29.png alt></p><ul><li>在弹出的“新建命名空间”页面，填写命名空间信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2841%29.png alt></p><ul><li><strong>名称：</strong> 命名空间名字，不超过63字符</li><li><strong>描述：</strong> 命名空间描述信息（可选）</li><li><strong>权限类型：</strong> 选择命名空间权限类型<ul><li><strong>公有：</strong> 所有人均可访问该命名空间下的镜像</li><li><strong>私有：</strong> 个人用户命名空间</li></ul></li><li>单击【确认】按钮</li></ul><h3 id=删除命名空间>删除命名空间</h3><ul><li>登录 TKEStack</li><li>切换至 【平台管理】控制台，选择 【组织资源】->【镜像仓库管理】。点击列表最右侧【删除】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28106%29.png alt></p><h3 id=镜像上传>镜像上传</h3><ul><li>登录 TKEStack</li><li>切换至 【平台管理】控制台，选择 【组织资源】->【镜像仓库管理】，查看命名空间列表，点击列表中命名空间【名称】，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2881%29.png alt></p><ul><li><p>此时进入了“镜像列表”页面，点击【镜像上传指引】按钮，如下图所示：</p><blockquote><p>注意：此页面可以通过上传的镜像最右边的【删除】按钮来删除上传的镜像</p></blockquote></li></ul><p><img src=../../../../../images/image%20%2868%29.png alt></p><ul><li>根据指引内容，在物理节点上执行相应命令，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2833%29.png alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-26f3f5de560aa7df709ac0f6721cad7a>5.2 - Helm模板</h1><div class=lead>Helm模板</div><p>应用功能是 TKEStack 集成的 <a href=https://helm.sh/>Helm 3.0</a> 相关功能，为您提供创建 helm chart、容器镜像、软件服务等各种产品和服务的能力。已创建的应用将在您指定的集群中运行，为您带来相应的能力。</p><h2 id=模板>模板</h2><ul><li>登录 TKEStack</li><li>切换至 【平台管理】控制台，选择 【组织资源】->【 Helm模板】，点击【模板】</li></ul><p><img src=../../../../../images/image-20201203144524973.png alt=image-20201203144524973></p><ol><li><strong>所有模板</strong>：包含下列所有模板</li><li><strong>用户模板</strong>：权限范围为“指定用户”的仓库下的所有模板</li><li><strong>业务模板</strong>：权限范围为“指定业务”的仓库下的所有模板</li><li><strong>公共模板</strong>：权限范围为“公共”的仓库下的所有模板</li></ol><h2 id=仓库>仓库</h2><ul><li>登录 TKEStack</li><li>切换至 【平台管理】控制台，选择 【组织资源】->【 Helm模板】，点击【仓库】</li><li>点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/Chart%E5%8C%85%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4.png alt=&#x65B0;&#x5EFA;Chart&#x5305;&#x547D;&#x540D;&#x7A7A;&#x95F4;></p><ul><li>在弹出的 “新建仓库” 页面，填写 仓库 信息，如下图所示：</li></ul><p><img src=../../../../../images/image-20201203144754466.png alt=image-20201203144754466></p><ul><li><p><strong>仓库名称：</strong> 仓库名字，不超过60个字符</p></li><li><p><strong>权限访问</strong></p><ul><li><strong>指定用户</strong>：选择当前仓库可以被哪些平台的用户访问</li><li><strong>指定业务</strong>：选择当前仓库可以被哪些平台的业务访问，业务下的成员对该仓库的访问权限在【业务管理】中完成</li><li><strong>公共</strong>：平台所有用户都能访问该仓库</li></ul></li><li><p><strong>导入第三方仓库：</strong> 若已有仓库想导入 TKEStack 中使用，请勾选</p><ul><li><strong>第三方仓库地址</strong>：请输入第三方仓库地址</li><li><strong>第三方仓库用户名</strong>：若第三方仓库开启了鉴权，需要输入第三方仓库的用户名</li><li><strong>第三方仓库密码</strong>：若第三方仓库开启了鉴权，需要输入第三方仓库的密码</li></ul></li><li><p><strong>仓库描述：</strong> 请输入仓库描述，不超过255个字符</p></li><li><p>单击【确认】按钮</p><p><strong>删除仓库</strong></p></li><li><p>登录 TKEStack</p></li><li><p>切换至 【平台管理】控制台，选择 【组织资源】-> 【 Helm 模板】，点击【仓库】，查看 “helm模板仓库”列表</p></li><li><p>点击列表最右侧【删除】按钮，如下图所示：</p></li></ul><p><img src=../../../../../images/Chart%E5%8C%85%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%88%A0%E9%99%A4%E6%8C%89%E9%92%AE%20%281%29.png alt=Chart&#x5305;&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x5220;&#x9664;&#x6309;&#x94AE;></p><p><strong>Chart 上传指引</strong></p><ul><li>登录 TKEStack</li><li>切换至 【平台管理】控制台，选择 【组织资源】-> 【 Helm模板】，点击【仓库】，查看 “helm模板仓库”列表</li><li>点击列表最右侧【上传指引】按钮，如下图所示：</li></ul><p><img src=../../../../../images/Chart%E5%8C%85%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%90%8D%E7%A7%B0%20%281%29.png alt=Chart&#x5305;&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x540D;&#x79F0;></p><ul><li>根据指引内容，在物理节点上执行相应命令，如下图所示：</li></ul><p><img src=../../../../../images/Chart%E4%B8%8A%E4%BC%A0%E6%8C%87%E5%BC%95%E5%86%85%E5%AE%B9.png alt=Chart&#x4E0A;&#x4F20;&#x6307;&#x5F15;&#x5185;&#x5BB9;></p><h2 id=同步导入仓库>同步导入仓库</h2><ol><li>登录 TKEStack</li><li>切换至 【平台管理】控制台，选择 【组织资源】->【 Helm模板】，点击【仓库】</li><li>点击导入仓库的【同步仓库】按钮，如下图所示：</li></ol><p><img src=../../../../../images/image-20201203151341971.png alt=image-20201203151341971></p></div><div class=td-content style=page-break-before:always><h1 id=pg-e90c4b8de7956382e8cb823e234fcfdc>5.3 - 访问凭证</h1><div class=lead>访问凭证</div><h2 id=访问凭证>访问凭证</h2><p><strong>这里用户可以管理自己的凭据，用来登陆平台创建的</strong><a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/products/platform/resource/registry.md><strong>镜像仓库</strong></a><strong>和</strong><a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/products/platform/resource/helm.md><strong>应用仓库</strong></a><strong>。</strong></p><h3 id=新建访问凭证>新建访问凭证</h3><ul><li>登录 TKEStack</li><li>切换至 【平台管理】控制台，选择 【组织资源】下的【访问凭证】，点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2899%29.png alt></p><ul><li>在弹出创建访问凭证页面，填写凭证信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2811%29.png alt></p><ul><li><strong>凭证描述：</strong> 描述当前凭证信息</li><li><strong>过期时间：</strong> 填写过期时间，选择小时/分钟为单位</li><li>单击【确认】按钮</li></ul><h3 id=使用指引>使用指引</h3><ul><li>登录 TKEStack</li><li>切换至 【平台管理】控制台，选择 【组织资源】下的【访问凭证】，点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2844%29.png alt></p><ul><li>根据指引内容，在物理节点上执行相应命令</li></ul><h3 id=停用启用删除访问凭证>停用/启用/删除访问凭证</h3><ul><li><p>登录 TKEStack</p></li><li><p>切换至 【平台管理】控制台，选择 【组织资源】-> 【访问凭证】，查看“访问凭证”列表，单击列表右侧【禁用】/【启用】/【删除】按钮。如下图所示：</p><blockquote><p>注意：点击【禁用】之后，【禁用】按钮就变成了【启用】</p></blockquote></li></ul><p><img src=../../../../../images/image%20%2855%29.png alt></p><ul><li>单击【确认】按钮</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1e2e6f8e38db1566b319ae4dcf54e5bd>6 - 访问管理</h1><div class=lead>访问管理</div></div><div class=td-content><h1 id=pg-2afb350b927ffbe1b6aefc8291b4faba>6.1 - 策略管理</h1><div class=lead>策略管理</div><h2 id=策略管理>策略管理</h2><h3 id=平台策略>平台策略</h3><h4 id=新建策略>新建策略</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【策略管理】</li><li>点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2840%29.png alt></p><ul><li>在弹出的新建策略窗口输入策略信息。如下图所示：</li></ul><p><img src=../../../../../images/image%20%2874%29.png alt></p><ul><li><strong>策略名称：</strong> 长度需要小于256个字符</li><li><strong>效果：</strong> 策略动作，允许/拒绝</li><li><strong>服务：</strong> 选择策略应用于哪项服务</li><li><strong>操作：</strong> 选择对应服务的各项操作权限</li><li><strong>资源：</strong> 输入资源label，支持模糊匹配，策略将应用于匹配到的资源</li><li><strong>描述：</strong> 输入策略描述</li><li>单击【保存】按钮</li></ul><h4 id=关联用户和用户组>关联用户和用户组</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【策略管理】，查看策略列表</li><li>点击列表中最右侧【关联用户】或【关联用户组】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2853%29.png alt></p><ul><li>在弹出的关联用户窗口选择用户或用户组，这里以用户组为例。如下图所示：</li></ul><p><img src=../../../../../images/image%20%2864%29.png alt></p><ul><li>单击【确定】按钮</li></ul><h4 id=编辑策略基本信息>编辑策略基本信息</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【策略管理】，查看策略列表</li><li>点击列表中的策略名称，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2831%29.png alt></p><ul><li>在策略基本信息页面，单击 “基本信息” 旁的【编辑】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2851%29.png alt></p><ul><li>在弹出的信息框内编辑策略名称和描述</li><li>单击【保存】按钮</li></ul><h3 id=业务策略>业务策略</h3><h4 id=新建策略-1>新建策略</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【策略管理】->【业务策略】</li><li>点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28129%29.png alt></p><ul><li>在弹出的新建策略窗口输入策略信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2862%29.png alt></p><ul><li><strong>策略名称：</strong> 长度需要小于256个字符</li><li><strong>效果：</strong> 策略动作，允许/拒绝</li><li><strong>服务：</strong> 选择策略应用于哪项服务</li><li><strong>操作：</strong> 选择对应服务的各项操作权限</li><li><strong>资源：</strong> 输入资源label，支持模糊匹配，策略将应用于匹配到的资源</li><li><strong>描述：</strong> 输入策略描述</li><li>单击【保存】按钮</li></ul><h4 id=编辑策略基本信息-1>编辑策略基本信息</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【策略管理】，查看策略列表</li><li>点击列表中的策略名称，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2857%29.png alt></p><ul><li>在策略基本信息页面，单击 “基本信息” 旁的【编辑】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2838%29.png alt></p><ul><li>在弹出的信息框内编辑策略名称和描述</li><li>单击【保存】按钮</li><li>此页面还可以编辑策略语法</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b8df25d88d18c9314eee7073f7e19ed4>6.2 - 用户管理</h1><div class=lead>用户管理</div><h2 id=用户管理>用户管理</h2><h3 id=用户>用户</h3><h4 id=新建用户>新建用户</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【用户管理】</li><li>点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2845%29.png alt></p><ul><li>在弹出的添加用户窗口填写用户信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%281%29.png alt></p><ul><li><strong>用户账号：</strong> 长度3～32位字符，小写字母或数字开头结尾，中间包含小写字母、数字、-</li><li><strong>用户名称：</strong> 长度需小于256字符，用户名称会显示在页面右上角</li><li><strong>用户密码：</strong> 10~16位字符，需包括大小写字母及数字</li><li><strong>确认密码：</strong> 再次输入密码</li><li><strong>手机号：</strong> 输入用户手机号</li><li><strong>邮箱：</strong> 输入用户邮箱</li><li><strong>平台角色：</strong><ul><li><strong>管理员：</strong> 平台预设角色，允许访问和管理所有平台和业务的功能和资源</li><li><strong>平台用户：</strong> 平台预设角色，允许访问和管理大部分平台功能，可以新建集群及业务</li><li><strong>租户：</strong> 平台预设角色，不绑定任何平台权限，仅能登录</li><li><strong>自定义：</strong> 通过勾选下面的策略给用户自定义独立的权限</li></ul></li><li>单击【保存】按钮</li></ul><h4 id=修改密码>修改密码</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【用户管理】，查看用户列表</li><li>点击用户列表最右侧的【修改密码】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2819%29.png alt></p><ul><li>在弹出的修改密码窗口里输入新的密码并确认，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28101%29.png alt></p><ul><li>单击【保存】按钮</li></ul><h4 id=编辑用户基本信息>编辑用户基本信息</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【用户管理】，查看用户列表</li><li>点击列表中的用户名称，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28103%29.png alt></p><ul><li>在用户基本信息页面，单击 基本信息 旁的【编辑】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28112%29.png alt></p><ul><li>在弹出的用户信息框内编辑用户信息</li><li>单击【保存】按钮</li><li>此页面下面可以查看当前用户的 已管理策略、已关联用户组 和 已关联角色</li></ul><h3 id=用户组>用户组</h3><h4 id=新建用户组>新建用户组</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【用户管理】-> 【用户组】</li><li>点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2865%29.png alt></p><ul><li>在弹出的添加用户窗口填写用户信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2867%29.png alt></p><ul><li><strong>用户组名称：</strong> 长度需小于60位字符，小写字母或数字开头结尾，中间包含小写字母、数字、-</li><li><strong>用户组描述：</strong> 长度需小于255字符</li><li><strong>关联用户：</strong> 点按用户ID/名称前面的方框可以关联相应的用户，支持全选和按住shift键多选</li><li><strong>平台角色：</strong><ul><li><strong>管理员：</strong> 平台预设角色，允许访问和管理所有平台和业务的功能和资源</li><li><strong>平台用户：</strong> 平台预设角色，允许访问和管理大部分平台功能，可以新建集群及业务</li><li><strong>租户：</strong> 平台预设角色，不绑定任何平台权限，仅能登录</li><li><strong>自定义：</strong> 通过勾选下面的策略给用户自定义独立的权限</li></ul></li><li>单击【提交】按钮</li></ul><h4 id=编辑用户组基本信息>编辑用户组基本信息</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【用户组管理】，查看用户组列表</li><li>点击列表中的用户组名称，如下图1所示：</li></ul><p><img src=../../../../../images/image%20%2892%29.png alt></p><blockquote><p>此界面也可以更改关联用户，如上图中的2所示，和 新建用户组 ->添加用户组 中一样的步骤来关联用户</p></blockquote><ul><li>在用户组基本信息页面，单击 基本信息 旁的【编辑】按钮，如下图1所示：</li></ul><p><img src=../../../../../images/image%20%2814%29.png alt></p><ul><li><p>在弹出的信息框内可以编辑 用户组名称 和 用户组描述，此时会出现【提交】按钮，点击后可更改用户组基本信息。</p><blockquote><p>如上图中的2所示，此界面也可以更改关联用户，点击蓝色【关联用户】按钮后，和 新建用户组 ->添加用户组 中一样的操作来关联用户。这里还可以点击查看【已关联角色】和【已关联策略】</p></blockquote></li></ul><h4 id=删除用户组>删除用户组</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【访问管理】->【用户组管理】，查看用户组列表</li><li>点击用户组列表最右侧的【删除】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2870%29.png alt></p><ul><li>在弹出的确认删除窗口，单击【确认】</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b22c0bde169ab6bdc225b49782930706>7 - 监控&告警</h1><div class=lead>监控&告警</div></div><div class=td-content><h1 id=pg-23a8b7f582c270bcb790b3707905d346>7.1 - 告警记录</h1><div class=lead>告警记录</div><h3 id=概念>概念</h3><p><strong>这里可以查看历史告警记录</strong></p><h3 id=查看历史告警记录>查看历史告警记录</h3><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【告警记录】查看“历史告警记录”列表，如下图所示：</li></ul><p><img src=https://github.com/tkestack/tke/raw/master/docs/images/%E5%91%8A%E8%AD%A6%E8%AE%B0%E5%BD%95.png alt=&#x5220;&#x9664;&#x63A5;&#x6536;&#x7EC4;></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c677185f730a103f7429f6161d3c5546>7.2 - 通知设置</h1><div class=lead>通知设置</div><h2 id=通知设置>通知设置</h2><h3 id=概念>概念</h3><p><strong>这里用户配置平台通知</strong></p><h3 id=通知渠道>通知渠道</h3><h4 id=新建通知渠道>新建通知渠道</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【通知渠道】，查看“通知渠道”列表</li><li>点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2826%29.png alt></p><ul><li>在“新建通知渠道”页面填写渠道信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2889%29.png alt></p><ul><li><strong>名称：</strong> 填写渠道名称</li><li><strong>渠道：</strong> 选择渠道类型，输入渠道信息<ul><li><strong>邮件：</strong> 邮件类型<ul><li><strong>email：</strong> 邮件发送放地址</li><li><strong>password：</strong> 邮件发送方密码</li><li><strong>smtpHost：</strong> smtp IP 地址</li><li><strong>smtpPort：</strong> smtp 端口</li><li><strong>tls：</strong> 是否使用tls加密</li></ul></li><li><strong>短信：</strong> 短信方式<ul><li><strong>appKey：</strong> 短信发送方的 appKey</li><li><strong>sdkAppID：</strong> sdkAppID</li><li><strong>extend：</strong> extend 信息</li></ul></li><li><strong>微信公众号：</strong> 微信公众号方式<ul><li><strong>appID：</strong> 微信公众号 appID</li><li><strong>appSecret：</strong> 微信公众号 appSecret</li></ul></li><li><strong>Webhook：</strong> Webhook 方式<ul><li><strong>URL</strong>：Webhook 的 URL</li><li><strong>Headers：</strong> 自定义 Header</li></ul></li></ul></li><li>单击【保存】按钮</li></ul><h4 id=编辑通知渠道>编辑通知渠道</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【通知渠道】，查看“通知渠道”列表</li><li>单击渠道名称，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28120%29.png alt></p><ul><li>在“基本信息”页面，单击【基本信息】右侧的【编辑】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2891%29.png alt></p><ul><li>在“更新渠道通知”页面，编辑渠道信息</li><li>单击【保存】按钮</li></ul><h4 id=删除通知渠道>删除通知渠道</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【通知渠道】，查看“通知渠道”列表</li><li>选择要删除的渠道，点击【删除】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2813%29.png alt></p><ul><li>单击删除窗口的【确定】按钮</li></ul><h3 id=通知模板>通知模板</h3><h4 id=新建通知模版>新建通知模版</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【通知模板】，查看“通知模板”列表</li><li>点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%285%29.png alt></p><ul><li>在“新建通知模版”页面填写模版信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2837%29.png alt></p><ul><li><strong>名称：</strong> 模版名称</li><li><strong>渠道：</strong> 选择已创建的渠道</li><li><strong>body：</strong> 填写消息 body</li><li><strong>header：</strong> 填写消息 header</li><li>单击【保存】按钮</li></ul><h4 id=编辑通知模版>编辑通知模版</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【通知模板】，查看“通知模板”列表</li><li>单击模版名称，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2835%29.png alt></p><ul><li>在基本信息页面，单击【基本信息】右侧的【编辑】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28116%29.png alt></p><ul><li>在“更新通知模版”页面，编辑模版信息</li><li>单击【保存】按钮</li></ul><h4 id=删除通知模版>删除通知模版</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【通知模板】，查看"通知模板"列表</li><li>选择要删除的模版，点击【删除】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%288%29.png alt></p><ul><li>单击删除窗口的【确定】按钮</li></ul><h3 id=接收人>接收人</h3><h4 id=新建接收人>新建接收人</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【接收人】，查看"接收人"列表</li><li>点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2816%29.png alt></p><ul><li>在“新建接收人”页面填写模版信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2876%29.png alt></p><ul><li><strong>显示名称：</strong> 接收人显示名称</li><li><strong>用户名：</strong> 接收人用户名</li><li><strong>移动电话：</strong> 手机号</li><li><strong>电子邮件：</strong> 接收人邮箱</li><li><strong>微信OpenID：</strong> 接收人微信ID</li><li>单击【保存】按钮</li></ul><h4 id=编辑接收人信息>编辑接收人信息</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【接收人】，查看“接收人”列表</li><li>单击接收人名称，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28121%29.png alt></p><ul><li>在“基本信息”页面，单击【基本信息】右侧的【编辑】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2810%29.png alt></p><ul><li>在“更新接收人”页面，编辑接收人信息</li><li>单击【保存】按钮</li></ul><h4 id=删除接收人>删除接收人</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【接收人】，查看“接收人”列表</li><li>选择要删除的接收人，点击【删除】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2875%29.png alt></p><ul><li>单击删除窗口的【确定】按钮</li></ul><h3 id=接收组>接收组</h3><h4 id=新建接收组>新建接收组</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【接收组】，查看“接收组”列表</li><li>点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28131%29.png alt></p><ul><li>在“新建接收组”页面填写模版信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28111%29.png alt></p><ul><li><strong>名称：</strong> 接收组显示名称</li><li><strong>接收组：</strong> 从列表里选择接收人。如没有想要的接收人，请在<a href>接收人</a>里创建</li><li>单击【保存】按钮</li></ul><h4 id=编辑接收组信息>编辑接收组信息</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【接收组】，查看“接收组”列表</li><li>单击接收组名称，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2856%29.png alt></p><ul><li>在“基本信息”页面，单击【基本信息】右侧的【编辑】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28107%29.png alt></p><ul><li>在“更新接收组”页面，编辑接收组信息</li><li>单击【保存】按钮</li></ul><h4 id=删除接收组>删除接收组</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】->【通知设置】->【接收组】，查看“接收组”列表</li><li>选择要删除的接收组，点击【删除】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2842%29.png alt></p><ul><li>单击删除窗口的【确定】按钮</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-0a1a33c9e3221ae15fbb22a45f0ce01a>7.3 - 告警设置</h1><div class=lead>告警设置</div><h2 id=告警设置>告警设置</h2><h3 id=概念>概念</h3><p><strong>这里用户配置平台告警</strong></p><h3 id=前提条件>前提条件</h3><blockquote><p>需要设置告警的集群应该先在其 <a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/products/platform/cluster.md#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF>基本信息</a> 页里开启<strong>监控告警</strong></p></blockquote><h3 id=新建告警设置>新建告警设置</h3><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】下的【告警设置】，查看“告警设置”列表</li><li>选择相应【集群】，点击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28110%29.png alt></p><ul><li>在“新建策略”页面填写告警策略信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2822%29.png alt></p><ul><li><strong>告警策略名称：</strong> 输入告警策略名称，最长60字符</li><li><strong>策略类型：</strong> 选择告警策略应用类型<ul><li><strong>集群：</strong> 集群监控告警</li><li><strong>Pod：</strong> Pod 监控告警<ul><li><strong>告警对象：</strong> 选择 Pod 相关的告警对象，支持对 namespace 下不同的 deployment、stateful和daemonset 进行监控报警<ul><li><strong>按工作负载选择：</strong> 选择 namespace 下的某个工作负载</li><li><strong>全部选择：</strong> 不区分 namespace，全部监控</li></ul></li></ul></li><li><strong>节点：</strong> 节点监控告警</li></ul></li><li><strong>统计周期：</strong> 选择数据采集周期，支持1、2、3、4、5分钟</li><li><strong>指标：</strong> 选择告警指标，支持对监测值与指标值进行【大于/小于】比较，选择结果持续周期，如下图。指标具体含义可参考：[监控&告警指标含义](../../../../FAQ/Platform/alert&monitor-metrics）</li></ul><p><img src=../../../../../images/image%20%2885%29.png alt></p><ul><li><strong>接收组：</strong> 选择接收组，当出现满足条件当报警信息时，向组内人员发送消息。<strong>接收组需要先在</strong> <a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/products/platform/accessmanagement/user.md#%E7%94%A8%E6%88%B7%E7%BB%84><strong>用户管理</strong></a> <strong>创建</strong></li><li><strong>通知方式：</strong> 选择通知渠道和消息模版。<strong>通知渠道 和 消息模版需要先在</strong> <a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/products/platform/monitor%26alert/notification.md><strong>通知设置</strong></a> <strong>创建</strong><ul><li><strong>添加通知方式</strong> ：如需要添加多种通知方式，点击该按钮</li></ul></li><li>单击【提交】按钮</li></ul><h4 id=复制告警设置>复制告警设置</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】下的【告警设置】，查看“告警设置”列表</li><li>选择相应【集群】，点击告警设置列表最右侧的【复制】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28138%29.png alt></p><ul><li>在“复制策略”页面，编辑告警策略信息</li><li>单击【提交】按钮</li></ul><h4 id=编辑告警设置>编辑告警设置</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】下的【告警设置】，查看“告警设置”列表</li><li>选择相应【集群】，点击【告警名称】，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2827%29.png alt></p><ul><li>在“告警策略详情”页面，单击【基本信息】右侧的【编辑】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28115%29.png alt></p><ul><li>在“更新策略”页面，编辑策略信息</li><li>单击【提交】按钮</li></ul><h4 id=删除告警设置>删除告警设置</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】下的【告警设置】，查看“告警设置”列表</li><li>选择相应【集群】，点击列表最右侧的【删除】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2854%29.png alt></p><ul><li>在弹出的删除告警窗口，单击【确定】按钮</li></ul><h3 id=批量删除告警设置>批量删除告警设置</h3><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【监控&告警】下的【告警设置】，查看“告警设置”列表</li><li>选择相应【集群】，选择多个告警策略，单击告警设置下方的【删除】按钮。如下图所示：</li></ul><p><img src=../../../../../images/image%20%2895%29.png alt></p><ul><li>在弹出的删除告警窗口，单击【确定】按钮</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-09ccc45f60cc4e226d68fd40cba886e8>8 - 运维中心</h1><div class=lead>运维中心</div><h1 id=运维中心>运维中心</h1><h2 id=概念>概念</h2><p><strong>这里用户可以管理 Helm 应用、日志和集群事件持久化。</strong></p></div><div class=td-content><h1 id=pg-c33fc9e02cdad664bbb84e3fffcf6b82>8.1 - Helm应用</h1><div class=lead>Helm应用</div><p>应用功能是 TKEStack 集成的 <a href=https://helm.sh/>Helm 3.0</a> 相关功能，为您提供创建 helm chart、容器镜像、软件服务等各种产品和服务的能力。已创建的应用将在您指定的集群中运行，为您带来相应的能力。</p><h2 id=新建-helm-应用>新建 Helm 应用</h2><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【运维中心】->【 Helm 应用】</li><li>选择相应【集群】，单击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/platformhelm.png alt="&#x65B0;&#x5EFA; Helm &#x6309;&#x94AE;"></p><ul><li>在“新建 Helm 应用”页面填写Helm应用信息，如下图所示：</li></ul><p><img src=../../../../../images/%E6%96%B0%E5%BB%BAHelm%E5%BA%94%E7%94%A8.png alt="&#x65B0;&#x5EFA; Helm &#x5E94;&#x7528;"></p><ul><li><strong>应用名称：</strong> 输入应用名，1～63字符，只能包含小写字母、数字及分隔符("-")，且必须以小写字母开头，数字或小写字母结尾</li><li><strong>运行集群：</strong> 选择应用所在集群</li><li><strong>命名空间：</strong> 选择应用所在集群的命名空间</li><li><strong>类型：</strong> 当前仅支持 HelmV3</li><li><strong>Chart：</strong> 选择需要部署的 chart</li><li><strong>Chart版本：</strong> 选择 chart 的版本</li><li><strong>参数：</strong> 更新时如果选择不同版本的 Helm Chart，参数设置将被覆盖</li><li><strong>拟运行：</strong> 会返回模板渲染清单，即最终将部署到集群的 YAML 资源，不会真正执行安装</li><li>单击【完成】按钮</li></ul><h2 id=删除-helm-应用>删除 Helm 应用</h2><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【运维中心】->【 Helm 应用】</li><li>点击【删除】</li></ul><p><img src=../../../../../images/image-20201203150729694.png alt=image-20201203150729694></p><h2 id=查看-helm-应用资源列表>查看 Helm 应用资源列表</h2><ol><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【运维中心】->【 Helm 应用】</li><li>点击【应用名】后，点击【资源列表】，可查看该应用所有 Kubernetes 资源对象</li></ol><h2 id=查看-helm-应用详情>查看 Helm 应用详情</h2><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【运维中心】->【 Helm 应用】</li><li>点击【应用名】后，点击【应用详情】</li></ul><p><img src=../../../../../images/image-20201203150904452.png alt=image-20201203150904452></p><h2 id=查看-helm-应用版本历史>查看 Helm 应用版本历史</h2><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择【运维中心】->【 Helm 应用】</li><li>点击【应用名】后，点击【版本历史】，可查看该应用所部署的历史版本。可以通过选择不同的版本进行参数对比查看其版本区别</li></ul><p><img src=../../../../../images/image-20201203151027616.png alt=image-20201203151027616></p></div><div class=td-content style=page-break-before:always><h1 id=pg-26d04226b313f47a8e04a3e9fee4bd6e>8.2 - 日志采集</h1><div class=lead>日志采集</div><h2 id=日志采集>日志采集</h2><h3 id=概念>概念</h3><p>TKESTack 提供的集群内日志采集功能，支持将集群内服务或集群节点特定路径文件的日志发送至 Kafka、Elasticsearch 等消费端，支持采集容器标准输出日志，容器内文件日志以及主机内文件日志。更提供事件持久化、审计等功能，实时记录集群事件及操作日志记录，帮助运维人员存储和分析集群内部资源生命周期、资源调度、异常告警等情况。</p><p><img src=../../../../../images/image%20%2830%29.png alt></p><p>日志收集功能需要为每个集群手动开启。日志收集功能开启后，日志收集组件 logagent 会在集群内以 Daemonset 的形式运行。用户可以通过日志收集规则配置日志的采集源和消费端，日志收集 Agent 会从用户配置的采集源进行日志收集，并将日志内容发送至用户指定的消费端。需要注意的是，使用日志收集功能需要您确认 Kubernetes 集群内节点能够访问日志消费端。</p><ul><li><strong>采集容器标准输出日志</strong> ：采集集群内指定容器的标准输出日志，采集到的日志信息将会以 JSON 格式输出到用户指定的消费端，并会自动附加相关的 Kubernetes metadata， 包括容器所属 pod 的 label 和 annotation 等信息。</li><li><strong>采集容器内文件日志</strong> ：采集集群内指定 pod 内文件的日志，用户可以根据自己的需求，灵活的配置所需的容器和路径，采集到的日志信息将会以 JSON 格式输出到用户指定的消费端， 并会附加相关的 Kubernetes metadata，包括容器所属 pod 的 label 和 annotation 等信息。</li><li><strong>采集主机内文件日志</strong> ：采集集群内所有节点的指定主机路径的日志，logagent 会采集集群内所有节点上满足指定路径规则的文件日志，以 JSON 格式输出到用户指定的输出端， 并会附加用户指定的 metadata，包括日志来源文件的路径和用户自定义的 metadata。</li></ul><blockquote><p>注意：日志采集对接外部 Kafka 或 Elasticsearch，该功能需要额外开启，位置在集群 <a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/products/platform/cluster.md#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF>基本信息</a> 下面，点击开启“日志采集”服务。</p></blockquote><p>​</p><p><img src=../../../../../images/image%20%28137%29.png alt></p><h3 id=新建日志采集规则>新建日志采集规则</h3><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【运维中心】->【日志采集】</li><li>选择相应【集群】和【命名空间】，单击【新建】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28119%29.png alt></p><ul><li>在“新建日志采集”页面填写日志采集信息，如下图所示：</li></ul><p><img src=../../../../../images/image%20%2887%29.png alt></p><ul><li><strong>收集规则名称：</strong> 输入规则名，1～63字符，只能包含小写字母、数字及分隔符("-")，且必须以小写字母开头，数字或小写字母结尾</li><li><strong>所属集群：</strong> 选择所属集群</li><li><strong>类型：</strong> 选择采集类型<ul><li><strong>容器标准输出：</strong> 容器Stdout信息采集<ul><li><strong>日志源：</strong> 可以选择所有容器或者某个namespace下的所有容器/工作负载<ul><li><strong>所有容器：</strong> 所有容器</li><li><strong>指定容器：</strong> 某个Namespace下的所有容器或者工作负载</li></ul></li></ul></li><li><strong>容器文件路径：</strong> 容器内文件内容采集<ul><li><strong>日志源：</strong> 可以采集具体容器内的某个文件路径下的文件内容<ul><li><strong>工作负载选项：</strong> 选择某个namespace下的某种工作负载类型下的某个工作负载</li><li><strong>配置采集路径：</strong> 选择某个容器下的某个文件路径</li></ul></li></ul></li><li><strong>节点文件路径：</strong> 收集节点上某个路径下的文件内容<ul><li><strong>日志源：</strong><ul><li><strong>收集路径：</strong> 节点上日志收集路径</li><li><strong>metadata：</strong> key：value格式，收集的日志会带上metadata信息上报给消费端</li></ul></li></ul></li></ul></li><li><strong>消费端：</strong> 选择日志消费端<ul><li><p><strong>Kafka：</strong></p><ul><li><strong>访问地址：</strong> kafka ip 和端口</li><li><strong>主题（Topic）：</strong> kafka topic 名</li></ul></li><li><p><strong>Elasticsearch：</strong></p><blockquote><p>注意：当前只支持未开启用户登录认证的 ES 集群</p></blockquote><ul><li><strong>Elasticsearch地址：</strong> ES 地址，如：<a href=http://190.0.0.1:200/>http://190.0.0.1:200</a></li><li><strong>索引：</strong> ES索引，最长60个字符，只能包含小写字母、数字及分隔符("-"、"_"、"+")，且必须以小写字母开头</li></ul></li></ul></li><li>单击【完成】按钮</li></ul><h3 id=指定容器运行后的日志目录>指定容器运行后的日志目录</h3><p>LogAgent 除了支持日志规则的创建，也支持指定容器运行后的日志目录，可实现日志文件展示和下载。</p><blockquote><p>前提：需要在创建负载时挂载数据卷，并指定日志目</p></blockquote><p><img src=../../../../../images/image%20%28102%29.png alt></p><p>创建负载以后，在<code>/data/logdir</code>目录下的所有文件可以展示并下载，不仅是日志文件，例如我们在容器的<code>/data/logdir</code>下新建一个名为<code>a.log</code>的文件，如果有内容的话，也可以在这里展示与下载</p><p><img src=../../../../../images/image%20%2886%29.png alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-771091872cb56b9e533c1ead93c239a3>8.3 - 审计记录</h1><div class=lead>审计记录</div><h2 id=简介>简介</h2><p>TKEStack 集群审计是基于 <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/audit>Kubernetes Audit</a> 对 kube-apiserver 产生的可配置策略的 JSON 结构日志的记录存储及检索功能。本功能记录了对 kube-apiserver 的访问事件，会按顺序记录每个用户、管理员或系统组件影响集群的活动。</p><h3 id=功能优势>功能优势</h3><p>集群审计功能提供了区别于 metrics 的另一种集群观测维度。开启 TKEStack 集群审计后，<strong>会在集群里的 tke 命名空间下生成 tke-audit-api 的 Deployment</strong>，Kubernetes 可以记录每一次对集群操作的审计日志。每一条审计日志是一个 JSON 格式的结构化记录，包括元数据（metadata）、请求内容（requestObject）和响应内容（responseObject）三个部分。其中元数据（包含了请求的上下文信息，例如谁发起的请求、从哪里发起的、访问的 URI 等信息）一定会存在，请求和响应内容是否存在取决于审计级别。通过日志可以了解到以下内容：</p><ul><li>集群里发生的活动</li><li>活动的发生时间及发生对象。</li><li>活动的触发时间、触发位置及观察点</li><li>活动的结果以及后续处理行为</li></ul><h3 id=阅读审计日志>阅读审计日志</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>{
  &#34;kind&#34;:&#34;Event&#34;,
  &#34;apiVersion&#34;:&#34;audit.k8s.io/v1&#34;,
  &#34;level&#34;:&#34;RequestResponse&#34;,
  &#34;auditID&#34;:0a4376d5-307a-4e16-a049-24e017******,
  &#34;stage&#34;:&#34;ResponseComplete&#34;,
  // 发生了什么
  &#34;requestURI&#34;:&#34;/apis/apps/v1/namespaces/default/deployments&#34;,
  &#34;verb&#34;:&#34;create&#34;,
  // 谁发起的
  &#34;user&#34;:{
    &#34;username&#34;:&#34;admin&#34;,
      &#34;uid&#34;:&#34;admin&#34;,
      &#34;groups&#34;:[
        &#34;system:masters&#34;,
        &#34;system:authenticated&#34;
      ]
  },
  // 从哪里发起
  &#34;sourceIPs&#34;:[
    &#34;10.0.6.68&#34;
  ],
  &#34;userAgent&#34;:&#34;kubectl/v1.16.3 (linux/amd64) kubernetes/ald64d8&#34;,
  // 发生了什么
  &#34;objectRef&#34;:{
    &#34;resource&#34;:&#34;deployments&#34;,
    &#34;namespace&#34;:&#34;default&#34;,
    &#34;name&#34;:&#34;nginx-deployment&#34;,
    &#34;apiGroup&#34;:&#34;apps&#34;,
    &#34;apiVersion&#34;:&#34;v1&#34;
  },
  // 结果是什么
  &#34;responseStatus&#34;:{
    &#34;metadata&#34;:{
    },
    &#34;code&#34;:201
  },
  // 请求及返回具体信息
  &#34;requestObject&#34;:Object{...},
  &#34;responseObject&#34;:Object{...},
  // 什么时候开始/结束
  &#34;requestReceivedTimestamp&#34;:&#34;2020-04-10T10:47:34.315746Z&#34;,
  &#34;stageTimestamp&#34;:&#34;2020-04-10T10:47:34.328942Z&#34;,
  // 请求被接收/拒绝的原因是什么
  &#34;annotations&#34;:{
    &#34;authorization.k8s.io/decision&#34;:&#34;allow&#34;,
    &#34;authorization.k8s.io/reason&#34;:&#34;&#34;
  }
}
</code></pre></div><h2 id=前提条件>前提条件</h2><blockquote><p>在 <a href=https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/installation/installation-procedures.md>Installer 安装页面</a>的控制台安装的第5步中，如下图所示，已经开启平台审计功能，并配置好 ElasticSearch：</p></blockquote><h2 id=查看审计>查看审计</h2><ol><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【运维中心】->【审计记录】，查看审计列表：</li></ol><p><img src=../../../../../images/image%20%2821%29.png alt></p><h2 id=参考>参考</h2><p>TKEStack 关于审计的相关配置：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># kube-apiserver 地址：/etc/kubernetes/manifests/kube-apiserver.yaml

--audit-policy-file=/etc/kubernetes/audit-policy.yaml # 审计策略
--audit-webhook-config-file=/etc/kubernetes/audit-api-client-config.yaml # 指定 Webhook backend 的配置文件

# 获取 TKEStack 审计组件的详细信息
kubectl describe deploy -ntke tke-audit-api 

# 获取 TKEStack 审计的相关配置
kubectl describe cm -ntke tke-audit-api 
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4fbbc556a6db65b71e6c43d79c98e91f>8.4 - 事件持久化</h1><div class=lead>事件持久化</div><h2 id=persistentevent>PersistentEvent</h2><h3 id=persistentevent-介绍>PersistentEvent 介绍</h3><p>Kubernetes Events 包括了 Kuberntes 集群的运行和各类资源的调度情况，对维护人员日常观察资源的变更以及定位问题均有帮助。TKEStack 支持为您的所有集群配置事件持久化功能，开启本功能后，会将您的集群事件实时导出到 ElasticSearch 的指定索引。</p><h4 id=persistentevent-使用场景>PersistentEvent 使用场景</h4><p>Kubernetes 事件是集群内部资源生命周期、资源调度、异常告警等情况产生的记录，可以通过事件深入了解集群内部发生的事情，例如调度程序做出的决策或者某些pod从节点中被逐出的原因。</p><p>kubernetes 默认仅提供保留一个小时的 kubernetes 事件到集群的 ETCD 里。 PersistentEvent 提供了将 Kubernetes 事件持久化存储的前置功能，允许您通过PersistentEvent 将集群内事件导出到您自有的存储端。</p><h4 id=persistentevent-限制条件>PersistentEvent 限制条件</h4><ol><li><strong>注意：当前只支持版本号为5的 ElasticSearch，且未开启 ElasticSearch 集群的用户登录认证</strong></li><li>安装 PersistentEvent 将占用集群0.2核 CPU,100MB 内存的资源</li><li>仅在1.8版本以上的 kubernetes 集群支持</li></ol><h4 id=部署在集群内kubernetes对象>部署在集群内kubernetes对象</h4><p>在集群内部署PersistentEvent Add-on , 将在集群内部署以下kubernetes对象</p><table><thead><tr><th style=text-align:left>kubernetes对象名称</th><th style=text-align:left>类型</th><th style=text-align:left>默认占用资源</th><th style=text-align:left>所属Namespaces</th></tr></thead><tbody><tr><td style=text-align:left>tke-persistent-event</td><td style=text-align:left>deployment</td><td style=text-align:left>0.2核CPU,100MB内存</td><td style=text-align:left>kube-system</td></tr></tbody></table><h3 id=persistentevent-使用方法>PersistentEvent 使用方法</h3><h4 id=在-扩展组件-里使用>在 扩展组件 里使用</h4><ol><li><p>登录 TKEStack</p></li><li><p>切换至【平台管理】控制台，选择 【扩展组件】，选择需要安装事件持久化组件的集群，安装 PersistentEvent 组件，注意安装 PersistentEvent 时需要在页面下方指定 ElasticSearch 的地址和索引</p><blockquote><p>注意：当前只支持版本号为5，且未开启用户登录认证的 ES 集群</p></blockquote></li></ol><h4 id=在-运维中心-里使用>在 运维中心 里使用</h4><ul><li>登录 TKEStack</li><li>切换至【平台管理】控制台，选择 【运维中心】->【事件持久化】，查看事件持久化列表</li><li>单击列表最右侧【设置】按钮，如下图所示：</li></ul><p><img src=../../../../../images/image%20%28114%29.png alt></p><ul><li>在“设置事件持久化”页面填写持久化信息<ul><li><p><strong>事件持久化存储：</strong> 是否进行持久化存储</p><blockquote><p>注意：当前只支持版本号为5，且未开启用户登录认证的 ES 集群</p></blockquote></li><li><p><strong>Elasticsearch地址：</strong> ES 地址，如：<a href=http://190.0.0.1:200/>http://190.0.0.1:200</a></p></li><li><p><strong>索引：</strong> ES索引，最长60个字符，只能包含小写字母、数字及分隔符("-"、"_"、"+")，且必须以小写字母开头</p></li></ul></li><li>单击【完成】按钮</li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/tkestack/tke aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The TKEStack Authors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/web/js/main.min.1911ee3ae98d7d6df3807cd00d8e31ae7d1c08ee0f0bb587529b0483da4e5464.js integrity="sha256-GRHuOumNfW3zgHzQDY4xrn0cCO4PC7WHUpsEg9pOVGQ=" crossorigin=anonymous></script></body></html>